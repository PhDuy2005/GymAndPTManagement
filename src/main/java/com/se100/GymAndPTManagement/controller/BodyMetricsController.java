package com.se100.GymAndPTManagement.controller;

import java.util.List;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springdoc.core.annotations.ParameterObject;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.se100.GymAndPTManagement.domain.requestDTO.ReqCreateBodyMetricsDTO;
import com.se100.GymAndPTManagement.domain.requestDTO.ReqUpdateBodyMetricsDTO;
import com.se100.GymAndPTManagement.domain.responseDTO.ResBodyMetricsDTO;
import com.se100.GymAndPTManagement.domain.responseDTO.ResultPaginationDTO;
import com.se100.GymAndPTManagement.domain.table.BodyMetrics;
import com.se100.GymAndPTManagement.service.BodyMetricsService;
import com.se100.GymAndPTManagement.util.annotation.ApiMessage;
import com.turkraft.springfilter.boot.Filter;

import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;

/**
 * Generated by: GitHub Copilot (Claude Sonnet 4.5)
 * Created by: PhDuy2005
 * Created at: 2026-01-14 12:00:00
 * Purpose: REST Controller for BodyMetrics management
 */
@RestController
@RequestMapping("/api/v1/body-metrics")
@RequiredArgsConstructor
public class BodyMetricsController {

    private final BodyMetricsService bodyMetricsService;
    Logger logger = LoggerFactory.getLogger(BodyMetricsController.class);

    @Operation(summary = "Create new body metrics record")
    @ApiResponses({
            @ApiResponse(responseCode = "201", description = "Body metrics created successfully"),
            @ApiResponse(responseCode = "400", description = "Invalid request data"),
            @ApiResponse(responseCode = "404", description = "Member or User not found"),
            @ApiResponse(responseCode = "401", description = "Unauthorized")
    })
    @PostMapping
    @ApiMessage("Create new body metrics") // approved
    public ResponseEntity<ResBodyMetricsDTO> createBodyMetrics(@Valid @RequestBody ReqCreateBodyMetricsDTO request) {
        logger.info(">>BODY METRICS CONTROLLER: Creating new body metrics for member ID: {}", request.getMemberId());
        ResBodyMetricsDTO created = bodyMetricsService.createBodyMetrics(request);
        logger.info(">>BODY METRICS CONTROLLER: Created body metrics with ID: {}", created.getId());
        return ResponseEntity.status(HttpStatus.CREATED).body(created);
    }

    @Operation(summary = "Get all body metrics")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "Success"),
            @ApiResponse(responseCode = "401", description = "Unauthorized")
    })
    @GetMapping
    @ApiMessage("Get all body metrics") // approved
    public ResponseEntity<List<ResBodyMetricsDTO>> getAllBodyMetrics() {
        List<ResBodyMetricsDTO> bodyMetrics = bodyMetricsService.getAllBodyMetrics();
        logger.info(">>BODY METRICS CONTROLLER: Retrieved all body metrics, count: {}", bodyMetrics.size());
        return ResponseEntity.ok(bodyMetrics);
    }

    @Operation(summary = "Fetch body metrics with filter and pagination")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "Success"),
            @ApiResponse(responseCode = "401", description = "Unauthorized")
    })
    @GetMapping("/fetch")
    @ApiMessage("Fetch body metrics with filter") // approved
    public ResponseEntity<ResultPaginationDTO> fetchBodyMetricsWithFilter(
            @Parameter(name = "filter", description = "Spring-Filter expression. VD: member.id==1 and measuredDate>='2026-01-01'", required = false, example = "member.id==1") @Filter Specification<BodyMetrics> specification,
            @ParameterObject Pageable pageable) {
        ResultPaginationDTO bodyMetrics = bodyMetricsService.handleFetchBodyMetrics(specification, pageable);
        logger.info(">>BODY METRICS CONTROLLER: Fetched body metrics with pagination, page: {}, size: {}",
                pageable.getPageNumber() + 1, pageable.getPageSize());
        return ResponseEntity.ok(bodyMetrics);
    }

    @Operation(summary = "Get body metrics by ID")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "Success"),
            @ApiResponse(responseCode = "404", description = "Body metrics not found"),
            @ApiResponse(responseCode = "401", description = "Unauthorized")
    })
    @GetMapping("/{id}")
    @ApiMessage("Get body metrics by ID") // approved
    public ResponseEntity<ResBodyMetricsDTO> getBodyMetricsById(@PathVariable("id") Long id) {
        ResBodyMetricsDTO bodyMetrics = bodyMetricsService.getBodyMetricsById(id);
        logger.info(">>BODY METRICS CONTROLLER: Retrieved body metrics with ID: {}", id);
        return ResponseEntity.ok(bodyMetrics);
    }

    @Operation(summary = "Get all body metrics by member ID")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "Success"),
            @ApiResponse(responseCode = "404", description = "Member not found"),
            @ApiResponse(responseCode = "401", description = "Unauthorized")
    })
    @GetMapping("/member/{memberId}")
    @ApiMessage("Get body metrics by member ID, descending order by measured date") // approved
    public ResponseEntity<List<ResBodyMetricsDTO>> getBodyMetricsByMemberId(
            @PathVariable("memberId") Long memberId) {
        List<ResBodyMetricsDTO> bodyMetrics = bodyMetricsService.getBodyMetricsByMemberId(memberId);
        logger.info(">>BODY METRICS CONTROLLER: Retrieved body metrics for member ID: {}, count: {}", memberId,
                bodyMetrics.size());
        return ResponseEntity.ok(bodyMetrics);
    }

    @Operation(summary = "Update body metrics")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "Body metrics updated successfully"),
            @ApiResponse(responseCode = "404", description = "Body metrics not found"),
            @ApiResponse(responseCode = "400", description = "Invalid request data"),
            @ApiResponse(responseCode = "401", description = "Unauthorized")
    })
    @PutMapping("/{id}")
    @ApiMessage("Update body metrics") // approved
    public ResponseEntity<ResBodyMetricsDTO> updateBodyMetrics(
            @PathVariable("id") Long id,
            @Valid @RequestBody ReqUpdateBodyMetricsDTO request) {
        ResBodyMetricsDTO updated = bodyMetricsService.updateBodyMetrics(id, request);
        logger.info(">>BODY METRICS CONTROLLER: Updated body metrics with ID: {}", id);
        return ResponseEntity.ok(updated);
    }

    @Operation(summary = "Delete body metrics")
    @ApiResponses({
            @ApiResponse(responseCode = "204", description = "Body metrics deleted successfully"),
            @ApiResponse(responseCode = "404", description = "Body metrics not found"),
            @ApiResponse(responseCode = "401", description = "Unauthorized")
    })
    @DeleteMapping("/{id}")
    @ApiMessage("Delete body metrics")
    public ResponseEntity<Void> deleteBodyMetrics(@PathVariable("id") Long id) {
        bodyMetricsService.deleteBodyMetrics(id);
        logger.info(">>BODY METRICS CONTROLLER: Deleted body metrics with ID: {}", id);
        return ResponseEntity.status(HttpStatus.NO_CONTENT).build();
    }
}
