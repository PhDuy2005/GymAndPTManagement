/**
 * Generated by: GitHub Copilot (Claude Haiku 4.5)
 * Created by: KStuv
 * Created at: 2026-01-14 11:15:00
 * Purpose: REST Controller for Checkin Log management
 */
package com.se100.GymAndPTManagement.controller;

import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;

import com.se100.GymAndPTManagement.domain.requestDTO.ReqCheckinDTO;
import com.se100.GymAndPTManagement.domain.requestDTO.ReqUpdateCheckinDTO;
import com.se100.GymAndPTManagement.domain.responseDTO.RestResponse;
import com.se100.GymAndPTManagement.domain.responseDTO.ResCheckinLogDTO;
import com.se100.GymAndPTManagement.domain.responseDTO.ResAttendanceTrackingDTO;
import com.se100.GymAndPTManagement.service.CheckinLogService;
import com.se100.GymAndPTManagement.util.annotation.ApiMessage;

import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;

import java.util.List;

import io.swagger.v3.oas.annotations.tags.Tag;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import io.swagger.v3.oas.annotations.responses.ApiResponses;

@RestController
@RequestMapping("/api/v1/checkins")
@RequiredArgsConstructor
@Tag(name = "Check-in Management", description = "APIs for member check-in and attendance tracking")
public class CheckinLogController {

    private final CheckinLogService checkinLogService;

    /**
     * Check-in: Create a new checkin log when member arrives
     * 
     * @param dto Check-in request with booking ID
     * @return Created checkin log details
     */
    @PostMapping
    @ApiMessage("Tạo check-in log khi thành viên đến tập")
    @Operation(summary = "Create check-in log", description = "Record member check-in for a specific booking")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "Check-in successful"),
            @ApiResponse(responseCode = "400", description = "Invalid check-in request"),
            @ApiResponse(responseCode = "404", description = "Booking not found")
    })
    public ResponseEntity<RestResponse<ResCheckinLogDTO>> checkIn(
            @Valid @RequestBody ReqCheckinDTO dto) {

        try {
            ResCheckinLogDTO createdLog = checkinLogService.checkIn(dto);

            return ResponseEntity.ok(
                    RestResponse.<ResCheckinLogDTO>builder()
                            .statusCode(200)
                            .message("Check-in thành công")
                            .data(createdLog)
                            .build());

        } catch (IllegalArgumentException e) {
            return ResponseEntity.badRequest()
                    .body(RestResponse.<ResCheckinLogDTO>builder()
                            .statusCode(400)
                            .error("VALIDATION_ERROR")
                            .message(e.getMessage())
                            .build());
        }
    }

    /**
     * Check-out: Update checkin log when member finishes workout
     * 
     * @param bookingId Booking ID to identify the checkin log
     * @return Updated checkin log details
     */
    @PutMapping("/checkout/{bookingId}")
    @ApiMessage("Cập nhật check-out khi thành viên kết thúc buổi tập")
    @Operation(summary = "Check-out member", description = "Record check-out when member finishes workout session")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "Check-out successful"),
            @ApiResponse(responseCode = "400", description = "Invalid checkout operation"),
            @ApiResponse(responseCode = "404", description = "Check-in log not found")
    })
    public ResponseEntity<RestResponse<ResCheckinLogDTO>> checkOut(
            @PathVariable Long bookingId) {

        try {
            ResCheckinLogDTO updatedLog = checkinLogService.checkOut(bookingId);

            return ResponseEntity.ok(
                    RestResponse.<ResCheckinLogDTO>builder()
                            .statusCode(200)
                            .message("Check-out thành công")
                            .data(updatedLog)
                            .build());

        } catch (IllegalArgumentException e) {
            return ResponseEntity.badRequest()
                    .body(RestResponse.<ResCheckinLogDTO>builder()
                            .statusCode(400)
                            .error("NOT_FOUND")
                            .message(e.getMessage())
                            .build());
        }
    }

    /**
     * Cancel: Cancel a checkin log when admin makes a mistake
     * 
     * @param bookingId Booking ID to identify the checkin log
     * @return Updated checkin log with CANCELLED status
     */
    @PutMapping("/cancel/{bookingId}")
    @ApiMessage("Hủy check-in khi admin thao tác nhầm")
    public ResponseEntity<RestResponse<ResCheckinLogDTO>> cancelCheckin(
            @PathVariable Long bookingId) {

        try {
            ResCheckinLogDTO cancelledLog = checkinLogService.cancelCheckin(bookingId);

            return ResponseEntity.ok(
                    RestResponse.<ResCheckinLogDTO>builder()
                            .statusCode(200)
                            .message("Hủy check-in thành công")
                            .data(cancelledLog)
                            .build());

        } catch (IllegalArgumentException e) {
            return ResponseEntity.badRequest()
                    .body(RestResponse.<ResCheckinLogDTO>builder()
                            .statusCode(400)
                            .error("NOT_FOUND")
                            .message(e.getMessage())
                            .build());
        }
    }

    /**
     * Get all checkin logs for a specific member
     * 
     * @param memberId Member ID
     * @return List of checkin logs
     */
    @GetMapping("/member/{memberId}")
    @ApiMessage("Lấy danh sách check-in của thành viên")
    public ResponseEntity<RestResponse<List<ResCheckinLogDTO>>> getCheckinsByMember(
            @PathVariable Long memberId) {

        List<ResCheckinLogDTO> logs = checkinLogService.getCheckinsByMember(memberId);

        return ResponseEntity.ok(
                RestResponse.<List<ResCheckinLogDTO>>builder()
                        .statusCode(200)
                        .message("Lấy danh sách check-in thành công")
                        .data(logs)
                        .build());
    }

    /**
     * Get all checkin logs for a specific booking
     * 
     * @param bookingId Booking ID
     * @return List of checkin logs
     */
    @GetMapping("/booking/{bookingId}")
    @ApiMessage("Lấy danh sách check-in của lịch đặt")
    public ResponseEntity<RestResponse<List<ResCheckinLogDTO>>> getCheckinsByBooking(
            @PathVariable Long bookingId) {

        List<ResCheckinLogDTO> logs = checkinLogService.getCheckinsByBooking(bookingId);

        return ResponseEntity.ok(
                RestResponse.<List<ResCheckinLogDTO>>builder()
                        .statusCode(200)
                        .message("Lấy danh sách check-in thành công")
                        .data(logs)
                        .build());
    }

    /**
     * Get checkin log by ID
     * 
     * @param checkinId Checkin log ID
     * @return Checkin log details
     */
    @GetMapping("/{checkinId}")
    @ApiMessage("Lấy chi tiết check-in log")
    public ResponseEntity<RestResponse<ResCheckinLogDTO>> getCheckinById(
            @PathVariable Long checkinId) {

        try {
            ResCheckinLogDTO log = checkinLogService.getCheckinById(checkinId);

            return ResponseEntity.ok(
                    RestResponse.<ResCheckinLogDTO>builder()
                            .statusCode(200)
                            .message("Lấy chi tiết check-in thành công")
                            .data(log)
                            .build());

        } catch (IllegalArgumentException e) {
            return ResponseEntity.badRequest()
                    .body(RestResponse.<ResCheckinLogDTO>builder()
                            .statusCode(400)
                            .error("NOT_FOUND")
                            .message(e.getMessage())
                            .build());
        }
    }

    /**
     * Get attendance tracking statistics for a member
     * 
     * Calculates:
     * - Total sessions from contract
     * - Remaining sessions
     * - Booked sessions (total - remaining)
     * - Attended sessions (count of CHECKED_OUT status)
     * - Attendance rate percentage
     * 
     * @param memberId Member ID
     * @return Attendance tracking statistics
     */
    @GetMapping("/attendance/{memberId}")
    @ApiMessage("Lấy thống kê tỷ lệ điểm danh của thành viên")
    public ResponseEntity<RestResponse<ResAttendanceTrackingDTO>> getAttendanceTracking(
            @PathVariable Long memberId) {

        try {
            ResAttendanceTrackingDTO attendanceStats = checkinLogService.getAttendanceTracking(memberId);

            return ResponseEntity.ok(
                    RestResponse.<ResAttendanceTrackingDTO>builder()
                            .statusCode(200)
                            .message("Lấy thống kê điểm danh thành công")
                            .data(attendanceStats)
                            .build());

        } catch (IllegalArgumentException e) {
            return ResponseEntity.badRequest()
                    .body(RestResponse.<ResAttendanceTrackingDTO>builder()
                            .statusCode(400)
                            .error("NOT_FOUND")
                            .message(e.getMessage())
                            .build());
        }
    }

    /**
     * Delete check-in log by ID
     * 
     * @param id Check-in log ID
     * @return No content response
     */
    @DeleteMapping("/{id}")
    @ApiMessage("Xóa check-in log")
    @Operation(summary = "Delete check-in log", description = "Delete a check-in log by ID")
    @ApiResponses({
            @ApiResponse(responseCode = "204", description = "Check-in log deleted successfully"),
            @ApiResponse(responseCode = "404", description = "Check-in log not found")
    })
    public ResponseEntity<Void> deleteCheckinLog(@PathVariable Long id) {
        try {
            checkinLogService.deleteCheckinLog(id);
            return ResponseEntity.noContent().build();
        } catch (IllegalArgumentException e) {
            return ResponseEntity.status(HttpStatus.NOT_FOUND).build();
        }
    }

    /**
     * Update check-in log information
     * PUT /api/v1/checkins/{id}
     * 
     * @param id Check-in log ID
     * @param request Update request with new check-in information
     * @return Updated check-in log details
     */
    @PutMapping("/{id}")
    @ApiMessage("Cập nhật thông tin check-in")
    @Operation(
        summary = "Update check-in log information",
        description = "Update check-in log details including associated booking, check-in time, and optional check-out time. "
                    + "Validates that check-out time (if provided) is after check-in time."
    )
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "Check-in log updated successfully"),
            @ApiResponse(responseCode = "400", description = "Validation error - check-out time before check-in time"),
            @ApiResponse(responseCode = "404", description = "Check-in log or booking not found")
    })
    public ResponseEntity<RestResponse<ResCheckinLogDTO>> updateCheckinLog(
            @PathVariable Long id,
            @Valid @RequestBody ReqUpdateCheckinDTO request) {
        try {
            ResCheckinLogDTO updatedCheckinLog = checkinLogService.updateCheckinLog(id, request);
            return ResponseEntity.ok(
                    RestResponse.<ResCheckinLogDTO>builder()
                            .statusCode(200)
                            .message("Cập nhật check-in log thành công")
                            .data(updatedCheckinLog)
                            .build());
        } catch (IllegalArgumentException e) {
            return ResponseEntity.badRequest()
                    .body(RestResponse.<ResCheckinLogDTO>builder()
                            .statusCode(400)
                            .error("VALIDATION_ERROR")
                            .message(e.getMessage())
                            .build());
        } catch (Exception e) {
            return ResponseEntity.badRequest()
                    .body(RestResponse.<ResCheckinLogDTO>builder()
                            .statusCode(400)
                            .error("VALIDATION_ERROR")
                            .message(e.getMessage())
                            .build());
        }
    }
}
