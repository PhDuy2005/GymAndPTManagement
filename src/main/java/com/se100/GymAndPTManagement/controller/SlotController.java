package com.se100.GymAndPTManagement.controller;

import java.util.List;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springdoc.core.annotations.ParameterObject;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.se100.GymAndPTManagement.domain.requestDTO.ReqCreateSlotDTO;
import com.se100.GymAndPTManagement.domain.requestDTO.ReqUpdateSlotDTO;
import com.se100.GymAndPTManagement.domain.responseDTO.ResSlotDTO;
import com.se100.GymAndPTManagement.domain.responseDTO.ResultPaginationDTO;
import com.se100.GymAndPTManagement.domain.table.Slot;
import com.se100.GymAndPTManagement.service.SlotService;
import com.se100.GymAndPTManagement.util.annotation.ApiMessage;
import com.turkraft.springfilter.boot.Filter;

import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;

/**
 * Generated by: GitHub Copilot (Claude Sonnet 4.5)
 * Created by: PhDuy2005
 * Created at: 2026-01-13 23:53:21
 * Purpose: REST Controller for Slot management
 */
@RestController
@RequestMapping("/api/v1/slots")
@RequiredArgsConstructor
public class SlotController {

    private final SlotService slotService;
    Logger logger = LoggerFactory.getLogger(SlotController.class);

    @Operation(summary = "Create new slot")
    @ApiResponses({
            @ApiResponse(responseCode = "201", description = "Slot created successfully"),
            @ApiResponse(responseCode = "400", description = "Invalid request data"),
            @ApiResponse(responseCode = "401", description = "Unauthorized")
    })
    @PostMapping
    @ApiMessage("Create new slot") // approved
    public ResponseEntity<ResSlotDTO> createSlot(@Valid @RequestBody ReqCreateSlotDTO request) {
        logger.info(">>SLOT CONTROLLER: Creating new slot with start time: {}, end time: {}",
                request.getStartTime(), request.getEndTime());
        ResSlotDTO created = slotService.createSlot(request);
        logger.info(">>SLOT CONTROLLER: Created slot with ID: {}", created.getId());
        return ResponseEntity.status(HttpStatus.CREATED).body(created);
    }

    @Operation(summary = "Get all slots")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "Success"),
            @ApiResponse(responseCode = "401", description = "Unauthorized")
    })
    @GetMapping
    @ApiMessage("Get all slots") // approved
    public ResponseEntity<List<ResSlotDTO>> getAllSlots() {
        List<ResSlotDTO> slots = slotService.getAllSlots();
        logger.info(">>SLOT CONTROLLER: Retrieved all slots, count: {}", slots.size());
        return ResponseEntity.ok(slots);
    }

    @Operation(summary = "Fetch slots with filter and pagination")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "Success"),
            @ApiResponse(responseCode = "401", description = "Unauthorized")
    })
    @GetMapping("/fetch")
    @ApiMessage("Fetch slots with filter") // approved
    public ResponseEntity<ResultPaginationDTO> fetchSlotsWithFilter(
            @Parameter(name = "filter", description = "Spring-Filter expression. VD: startTime>='08:00:00' and endTime<='10:00:00'", required = false, example = "startTime>='08:00:00'") @Filter Specification<Slot> specification,
            @ParameterObject Pageable pageable) {
        ResultPaginationDTO slots = slotService.handleFetchSlots(specification, pageable);
        logger.info(">>SLOT CONTROLLER: Fetched slots with pagination, page: {}, size: {}",
                pageable.getPageNumber() + 1, pageable.getPageSize());
        return ResponseEntity.ok(slots);
    }

    @Operation(summary = "Get slot by ID")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "Success"),
            @ApiResponse(responseCode = "404", description = "Slot not found"),
            @ApiResponse(responseCode = "401", description = "Unauthorized")
    })
    @GetMapping("/{id}")
    @ApiMessage("Get slot by ID") // approved
    public ResponseEntity<ResSlotDTO> getSlotById(@PathVariable("id") Long id) {
        ResSlotDTO slot = slotService.getSlotById(id);
        logger.info(">>SLOT CONTROLLER: Retrieved slot with ID: {}", id);
        return ResponseEntity.ok(slot);
    }

    @Operation(summary = "Update slot")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "Slot updated successfully"),
            @ApiResponse(responseCode = "404", description = "Slot not found"),
            @ApiResponse(responseCode = "400", description = "Invalid request data"),
            @ApiResponse(responseCode = "401", description = "Unauthorized")
    })
    @PutMapping("/{id}")
    @ApiMessage("Update slot") // approved
    public ResponseEntity<ResSlotDTO> updateSlot(
            @PathVariable("id") Long id,
            @Valid @RequestBody ReqUpdateSlotDTO request) {
        ResSlotDTO updated = slotService.updateSlot(id, request);
        logger.info(">>SLOT CONTROLLER: Updated slot with ID: {}", id);
        return ResponseEntity.ok(updated);
    }

    @Operation(summary = "Delete slot")
    @ApiResponses({
            @ApiResponse(responseCode = "204", description = "Slot deactivated successfully"),
            @ApiResponse(responseCode = "404", description = "Slot not found"),
            @ApiResponse(responseCode = "401", description = "Unauthorized")
    })
    @DeleteMapping("/{id}")
    @ApiMessage("Deactivate slot") // approved
    public ResponseEntity<Void> deleteSlot(@PathVariable("id") Long id) {
        slotService.deleteSlot(id);
        logger.info(">>SLOT CONTROLLER: Deactivated slot with ID: {}", id);
        return ResponseEntity.status(HttpStatus.NO_CONTENT).build();
    }

    @Operation(summary = "Get all active slots")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "Success"),
            @ApiResponse(responseCode = "401", description = "Unauthorized")
    })
    @GetMapping("/active")
    @ApiMessage("Get all active slots") // approved
    public ResponseEntity<List<ResSlotDTO>> getAllActiveSlots() {
        List<ResSlotDTO> slots = slotService.getAllActiveSlots();
        logger.info(">>SLOT CONTROLLER: Retrieved all active slots, count: {}", slots.size());
        return ResponseEntity.ok(slots);
    }

    @Operation(summary = "Activate slot")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "Slot activated successfully"),
            @ApiResponse(responseCode = "404", description = "Slot not found"),
            @ApiResponse(responseCode = "401", description = "Unauthorized")
    })
    @PutMapping("/{id}/activate")
    @ApiMessage("Activate slot") // approved
    public ResponseEntity<ResSlotDTO> activateSlot(@PathVariable("id") Long id) {
        ResSlotDTO activated = slotService.activateSlot(id);
        logger.info(">>SLOT CONTROLLER: Activated slot with ID: {}", id);
        return ResponseEntity.ok(activated);
    }
}
