package com.se100.GymAndPTManagement.controller;

import java.util.List;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springdoc.core.annotations.ParameterObject;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.se100.GymAndPTManagement.domain.requestDTO.ReqCreateAvailableSlotDTO;
import com.se100.GymAndPTManagement.domain.requestDTO.ReqUpdateAvailableSlotDTO;
import com.se100.GymAndPTManagement.domain.responseDTO.ResAvailableSlotDTO;
import com.se100.GymAndPTManagement.domain.responseDTO.ResultPaginationDTO;
import com.se100.GymAndPTManagement.domain.table.AvailableSlot;
import com.se100.GymAndPTManagement.service.AvailableSlotService;
import com.se100.GymAndPTManagement.util.annotation.ApiMessage;
import com.turkraft.springfilter.boot.Filter;

import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;

/**
 * Generated by: GitHub Copilot (Claude Sonnet 4.5)
 * Created by: PhDuy2005
 * Created at: 2026-01-14 10:19:59
 * Purpose: REST Controller for AvailableSlot management
 */
@RestController
@RequestMapping("/api/v1/available-slots")
@RequiredArgsConstructor
public class AvailableSlotController {

    private final AvailableSlotService availableSlotService;
    Logger logger = LoggerFactory.getLogger(AvailableSlotController.class);

    @Operation(summary = "Create new available slot")
    @ApiResponses({
            @ApiResponse(responseCode = "201", description = "Available slot created successfully"),
            @ApiResponse(responseCode = "400", description = "Invalid request data"),
            @ApiResponse(responseCode = "404", description = "PT or Slot not found"),
            @ApiResponse(responseCode = "401", description = "Unauthorized")
    })
    @PostMapping
    @ApiMessage("Create new available slot") // approved
    public ResponseEntity<ResAvailableSlotDTO> createAvailableSlot(
            @Valid @RequestBody ReqCreateAvailableSlotDTO request) {
        logger.info(">>AVAILABLE SLOT CONTROLLER: Creating new available slot for PT: {}, Slot: {}, Day: {}",
                request.getPtId(), request.getSlotId(), request.getDayOfWeek());
        ResAvailableSlotDTO created = availableSlotService.createAvailableSlot(request);
        logger.info(">>AVAILABLE SLOT CONTROLLER: Created available slot with ID: {}", created.getId());
        return ResponseEntity.status(HttpStatus.CREATED).body(created);
    }

    @Operation(summary = "Get all available slots")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "Success"),
            @ApiResponse(responseCode = "401", description = "Unauthorized")
    })
    @GetMapping
    @ApiMessage("Get all available slots") // approved
    public ResponseEntity<List<ResAvailableSlotDTO>> getAllAvailableSlots() {
        List<ResAvailableSlotDTO> slots = availableSlotService.getAllAvailableSlots();
        logger.info(">>AVAILABLE SLOT CONTROLLER: Retrieved all available slots, count: {}", slots.size());
        return ResponseEntity.ok(slots);
    }

    @Operation(summary = "Fetch available slots with filter and pagination")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "Success"),
            @ApiResponse(responseCode = "401", description = "Unauthorized")
    })
    @GetMapping("/fetch")
    @ApiMessage("Fetch available slots with filter") // approved
    public ResponseEntity<ResultPaginationDTO> fetchAvailableSlotsWithFilter(
            @Parameter(name = "filter", description = "Spring-Filter expression. VD: dayOfWeek=='MONDAY' and isAvailable==true", required = false, example = "dayOfWeek=='MONDAY'") @Filter Specification<AvailableSlot> specification,
            @ParameterObject Pageable pageable) {
        ResultPaginationDTO slots = availableSlotService.handleFetchAvailableSlots(specification, pageable);
        logger.info(">>AVAILABLE SLOT CONTROLLER: Fetched available slots with pagination, page: {}, size: {}",
                pageable.getPageNumber() + 1, pageable.getPageSize());
        return ResponseEntity.ok(slots);
    }

    @Operation(summary = "Get available slot by ID")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "Success"),
            @ApiResponse(responseCode = "404", description = "Available slot not found"),
            @ApiResponse(responseCode = "401", description = "Unauthorized")
    })
    @GetMapping("/{id}")
    @ApiMessage("Get available slot by ID") // approved
    public ResponseEntity<ResAvailableSlotDTO> getAvailableSlotById(@PathVariable("id") Long id) {
        ResAvailableSlotDTO slot = availableSlotService.getAvailableSlotById(id);
        logger.info(">>AVAILABLE SLOT CONTROLLER: Retrieved available slot with ID: {}", id);
        return ResponseEntity.ok(slot);
    }

    @Operation(summary = "Get available slots by PT ID")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "Success"),
            @ApiResponse(responseCode = "404", description = "PT not found"),
            @ApiResponse(responseCode = "401", description = "Unauthorized")
    })
    @GetMapping("/pt/{ptId}")
    @ApiMessage("Get available slots by PT ID") // approved
    public ResponseEntity<List<ResAvailableSlotDTO>> getAvailableSlotsByPtId(@PathVariable("ptId") Long ptId) {
        List<ResAvailableSlotDTO> slots = availableSlotService.getAvailableSlotsByPtId(ptId);
        logger.info(">>AVAILABLE SLOT CONTROLLER: Retrieved available slots for PT: {}, count: {}", ptId, slots.size());
        return ResponseEntity.ok(slots);
    }

    @Operation(summary = "Get available slots by PT ID (only available)")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "Success"),
            @ApiResponse(responseCode = "404", description = "PT not found"),
            @ApiResponse(responseCode = "401", description = "Unauthorized")
    })
    @GetMapping("/pt/{ptId}/available")
    @ApiMessage("Get available slots by PT ID (only available)") // approved
    public ResponseEntity<List<ResAvailableSlotDTO>> getAvailableSlotsByPtIdAndAvailable(
            @PathVariable("ptId") Long ptId) {
        List<ResAvailableSlotDTO> slots = availableSlotService.getAvailableSlotsByPtIdAndAvailable(ptId);
        logger.info(">>AVAILABLE SLOT CONTROLLER: Retrieved available slots (available only) for PT: {}, count: {}",
                ptId, slots.size());
        return ResponseEntity.ok(slots);
    }

    @Operation(summary = "Get all available slots by status")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "Success"),
            @ApiResponse(responseCode = "401", description = "Unauthorized")
    })
    @GetMapping("/status/{isAvailable}")
    @ApiMessage("Get all available slots by status") // approved
    public ResponseEntity<List<ResAvailableSlotDTO>> getAllAvailableSlotsByStatus(
            @PathVariable("isAvailable") Boolean isAvailable) {
        List<ResAvailableSlotDTO> slots = availableSlotService.getAllAvailableSlotsByStatus(isAvailable);
        logger.info(">>AVAILABLE SLOT CONTROLLER: Retrieved available slots with status: {}, count: {}", isAvailable,
                slots.size());
        return ResponseEntity.ok(slots);
    }

    @Operation(summary = "Update available slot")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "Available slot updated successfully"),
            @ApiResponse(responseCode = "404", description = "Available slot or Slot not found"),
            @ApiResponse(responseCode = "400", description = "Invalid request data"),
            @ApiResponse(responseCode = "401", description = "Unauthorized")
    })
    @PutMapping("/{availableSlotId}")
    @ApiMessage("Update available slot") // approved
    public ResponseEntity<ResAvailableSlotDTO> updateAvailableSlot(
            @PathVariable("availableSlotId") Long availableSlotId,
            @Valid @RequestBody ReqUpdateAvailableSlotDTO request) {
        ResAvailableSlotDTO updated = availableSlotService.updateAvailableSlot(availableSlotId, request);
        logger.info(">>AVAILABLE SLOT CONTROLLER: Updated available slot with ID: {}", availableSlotId);
        return ResponseEntity.ok(updated);
    }

    @Operation(summary = "Set available slot as available")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "Available slot set as available successfully"),
            @ApiResponse(responseCode = "404", description = "Available slot not found"),
            @ApiResponse(responseCode = "401", description = "Unauthorized")
    })
    @PutMapping("/{availableSlotId}/set-available")
    @ApiMessage("Set available slot as available") // approved
    public ResponseEntity<ResAvailableSlotDTO> setAvailable(@PathVariable("availableSlotId") Long availableSlotId) {
        ResAvailableSlotDTO updated = availableSlotService.setAvailableStatus(availableSlotId, true);
        logger.info(">>AVAILABLE SLOT CONTROLLER: Set available slot ID: {} as available", availableSlotId);
        return ResponseEntity.ok(updated);
    }

    @Operation(summary = "Set available slot as unavailable")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "Available slot set as unavailable successfully"),
            @ApiResponse(responseCode = "404", description = "Available slot not found"),
            @ApiResponse(responseCode = "401", description = "Unauthorized")
    })
    @PutMapping("/{availableSlotId}/set-unavailable")
    @ApiMessage("Set available slot as unavailable") // approved
    public ResponseEntity<ResAvailableSlotDTO> setUnavailable(@PathVariable("availableSlotId") Long availableSlotId) {
        ResAvailableSlotDTO updated = availableSlotService.setAvailableStatus(availableSlotId, false);
        logger.info(">>AVAILABLE SLOT CONTROLLER: Set available slot ID: {} as unavailable", availableSlotId);
        return ResponseEntity.ok(updated);
    }

    @Operation(summary = "Delete available slot (soft delete)")
    @ApiResponses({
            @ApiResponse(responseCode = "204", description = "Available slot deleted successfully"),
            @ApiResponse(responseCode = "404", description = "Available slot not found"),
            @ApiResponse(responseCode = "401", description = "Unauthorized")
    })
    @DeleteMapping("/{availableSlotId}")
    @ApiMessage("Delete available slot") // approved
    public ResponseEntity<Void> deleteAvailableSlot(@PathVariable("availableSlotId") Long availableSlotId) {
        availableSlotService.deleteAvailableSlot(availableSlotId);
        logger.info(">>AVAILABLE SLOT CONTROLLER: Deleted available slot with ID: {}", availableSlotId);
        return ResponseEntity.status(HttpStatus.NO_CONTENT).build();
    }

    @Operation(summary = "Set available by slotId, ptId and dayOfWeek. dayOfWeek could be written in any case (e.g., MONDAY, monday, Monday)")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "Available slot set as available successfully"),
            @ApiResponse(responseCode = "404", description = "Available slot, PT or Slot not found"),
            @ApiResponse(responseCode = "400", description = "Invalid day of week"),
            @ApiResponse(responseCode = "401", description = "Unauthorized")
    })
    @PutMapping("/set-available/slot/{slotId}/pt/{ptId}/day/{dayOfWeek}")
    @ApiMessage("Set available by slotId, ptId and dayOfWeek")
    public ResponseEntity<ResAvailableSlotDTO> setAvailableBySlotPtDay(
            @PathVariable("slotId") Long slotId,
            @PathVariable("ptId") Long ptId,
            @PathVariable("dayOfWeek") String dayOfWeek) {
        ResAvailableSlotDTO updated = availableSlotService.setAvailableBySlotPtDay(slotId, ptId, dayOfWeek);
        logger.info(">>AVAILABLE SLOT CONTROLLER: Set available for slotId: {}, ptId: {}, dayOfWeek: {}",
                slotId, ptId, dayOfWeek);
        return ResponseEntity.ok(updated);
    }
}
