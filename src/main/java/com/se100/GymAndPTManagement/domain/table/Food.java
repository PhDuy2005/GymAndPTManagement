package com.se100.GymAndPTManagement.domain.table;

import java.math.BigDecimal;
import java.time.Instant;

import com.se100.GymAndPTManagement.util.SecurityUtil;

import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.Index;
import jakarta.persistence.PrePersist;
import jakarta.persistence.PreUpdate;
import jakarta.persistence.Table;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

/**
 * Generated by: GitHub Copilot (Claude Sonnet 4.5)
 * Created by: PhDuy2005
 * Created at: 2026-01-15 14:30:00
 * Purpose: Food entity for nutrition database management
 */
@Entity
@Table(name = "foods", indexes = {
        @Index(name = "idx_food_name", columnList = "name"),
        @Index(name = "idx_food_type", columnList = "type"),
        @Index(name = "idx_food_status", columnList = "status")
})
@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class Food {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "food_id")
    private Long id;

    @Column(name = "name", nullable = false, length = 200, unique = true)
    private String name;

    @Column(name = "description", length = 1000)
    private String description;

    // Số gram protein trong 100g thực phẩm
    @Column(name = "protein", nullable = false, precision = 5, scale = 2)
    private BigDecimal protein;

    // Số gram carbohydrate trong 100g thực phẩm
    @Column(name = "carbohydrate", nullable = false, precision = 5, scale = 2)
    private BigDecimal carbohydrate;

    // Số gram fat trong 100g thực phẩm
    @Column(name = "fat", nullable = false, precision = 5, scale = 2)
    private BigDecimal fat;

    // Calories tự động tính: protein*4 + carb*4 + fat*9
    @Column(name = "calories", precision = 7, scale = 2)
    private BigDecimal calories;

    // Type tự động tính: chất dinh dưỡng có khối lượng lớn nhất
    // Values: "PROTEIN", "CARBOHYDRATE", "FAT"
    @Column(name = "type", length = 50)
    private String type;

    @Column(name = "food_photo", length = 500)
    private String foodPhoto;

    @Column(name = "notes", length = 1000)
    private String notes;

    @Column(name = "status", length = 20)
    @Builder.Default
    private String status = "ACTIVE";

    // Audit fields
    @Column(name = "created_at", nullable = false, updatable = false)
    private Instant createdAt;

    @Column(name = "updated_at")
    private Instant updatedAt;

    @Column(name = "created_by", length = 100)
    private String createdBy;

    @Column(name = "updated_by", length = 100)
    private String updatedBy;

    @PrePersist
    protected void onCreate() {
        createdAt = Instant.now();
        createdBy = SecurityUtil.getCurrentUserLogin().orElse("system");

        // Auto-calculate calories và type
        calculateNutrition();

        // Set default status
        if (status == null || status.isEmpty()) {
            status = "ACTIVE";
        }
    }

    @PreUpdate
    protected void onUpdate() {
        updatedAt = Instant.now();
        updatedBy = SecurityUtil.getCurrentUserLogin().orElse("system");

        // Re-calculate calories và type khi update
        calculateNutrition();
    }

    /**
     * Tính toán calories và type tự động
     * - Calories = protein*4 + carb*4 + fat*9 (kcal/100g)
     * - Type = chất dinh dưỡng có khối lượng lớn nhất
     */
    private void calculateNutrition() {
        if (protein != null && carbohydrate != null && fat != null) {
            // Calculate calories: protein*4 + carb*4 + fat*9
            BigDecimal proteinCalories = protein.multiply(new BigDecimal("4"));
            BigDecimal carbCalories = carbohydrate.multiply(new BigDecimal("4"));
            BigDecimal fatCalories = fat.multiply(new BigDecimal("9"));

            this.calories = proteinCalories.add(carbCalories).add(fatCalories);

            // Determine type based on highest macronutrient
            if (protein.compareTo(carbohydrate) >= 0 && protein.compareTo(fat) >= 0) {
                this.type = "PROTEIN";
            } else if (carbohydrate.compareTo(protein) >= 0 && carbohydrate.compareTo(fat) >= 0) {
                this.type = "CARBOHYDRATE";
            } else {
                this.type = "FAT";
            }
        }
    }
}
