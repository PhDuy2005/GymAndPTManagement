/**
 * Generated by: GitHub Copilot (Claude Haiku 4.5)
 * Created by: KStuv
 * Created at: 2026-01-14 10:00:00
 * Purpose: Repository for Booking entity with custom queries for dynamic filtering
 */
package com.se100.GymAndPTManagement.repository;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import com.se100.GymAndPTManagement.domain.table.Booking;
import com.se100.GymAndPTManagement.domain.table.PersonalTrainer;
import com.se100.GymAndPTManagement.domain.table.Slot;

import java.time.LocalDate;
import java.util.List;
import java.util.Optional;

@Repository
public interface BookingRepository extends JpaRepository<Booking, Long> {

    /**
     * Find all bookings by member ID
     */
    List<Booking> findByMemberId(Long memberId);

    /**
     * Find all bookings by personal trainer ID (realPt)
     */
    List<Booking> findByRealPtId(Long ptId);

    /**
     * Find booking by contract ID
     */
    List<Booking> findByContractId(Long contractId);

    /**
     * Find bookings by slot and date
     */
    List<Booking> findBySlotIdAndBookingDate(Long slotId, LocalDate bookingDate);

    /**
     * Find bookings by real PT, slot and date (for duplicate check)
     */
    Optional<Booking> findByRealPtIdAndSlotIdAndBookingDate(Long ptId, Long slotId, LocalDate bookingDate);

    /**
     * Find all bookings for a PT on a specific date
     */
    List<Booking> findByRealPtIdAndBookingDate(Long ptId, LocalDate bookingDate);

    /**
     * Get available slots for a PT on a specific date (Flow 1)
     * Returns slots that are:
     * 1. Configured in available_slots for the PT on the given day of week
     * 2. NOT already booked for this PT on the given date
     */
    @Query("""
        SELECT DISTINCT avs.slot FROM AvailableSlot avs
        WHERE avs.personalTrainer.id = :ptId
        AND avs.dayOfWeek = :dayOfWeek
        AND avs.isAvailable = true
        AND avs.slot.id NOT IN (
            SELECT b.slot.id FROM Booking b
            WHERE b.realPt.id = :ptId
            AND b.bookingDate = :bookingDate
        )
        ORDER BY avs.slot.startTime
    """)
    List<Slot> getAvailableSlotsForPT(
        @Param("ptId") Long ptId,
        @Param("dayOfWeek") String dayOfWeek,
        @Param("bookingDate") LocalDate bookingDate
    );

    /**
     * Get available PTs for a specific slot on a specific date (Flow 2)
     * Returns PTs that are:
     * 1. Configured in available_slots for the slot on the given day of week
     * 2. NOT already booked for this slot on the given date
     */
    @Query("""
        SELECT DISTINCT avs.personalTrainer FROM AvailableSlot avs
        WHERE avs.slot.id = :slotId
        AND avs.dayOfWeek = :dayOfWeek
        AND avs.isAvailable = true
        AND avs.personalTrainer.id NOT IN (
            SELECT b.realPt.id FROM Booking b
            WHERE b.slot.id = :slotId
            AND b.bookingDate = :bookingDate
        )
        ORDER BY avs.personalTrainer.user.fullname
    """)
    List<PersonalTrainer> getAvailablePTsForSlot(
        @Param("slotId") Long slotId,
        @Param("dayOfWeek") String dayOfWeek,
        @Param("bookingDate") LocalDate bookingDate
    );
}
