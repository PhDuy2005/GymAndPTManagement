/**
 * Generated by: GitHub Copilot (Claude Haiku 4.5)
 * Created by: KStuv
 * Created at: 2026-01-09 14:50:00
 * Purpose: Repository for Contract entity management
 */
package com.se100.GymAndPTManagement.repository;

import com.se100.GymAndPTManagement.domain.table.Contract;
import com.se100.GymAndPTManagement.util.enums.ContractStatusEnum;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;
import java.time.LocalDate;
import java.util.List;
import java.util.Optional;

@Repository
public interface ContractRepository extends JpaRepository<Contract, Long> {
    
    /**
     * Find all contracts for a member
     */
    List<Contract> findByMemberId(Long memberId);
    
    /**
     * Find all contracts for a personal trainer
     */
    List<Contract> findByMainPtId(Long ptId);
    
    /**
     * Find all contracts by status
     */
    List<Contract> findByStatus(ContractStatusEnum status);
    
    /**
     * Find all contracts by status, ordered by end date descending
     * Useful for displaying most recent contracts first
     */
    List<Contract> findByStatusOrderByEndDateDesc(ContractStatusEnum status);

    /**
     * Find active contracts for a member that covers a specific date
     * Used for booking validation - checks if member has valid contract on booking date
     * Returns list ordered by end date (earliest first) - caller should pick first one
     */
    @Query("""
        SELECT c FROM Contract c
        WHERE c.member.id = :memberId
        AND c.status = :status
        AND c.startDate <= :bookingDate
        AND c.endDate >= :bookingDate
        ORDER BY c.endDate ASC
    """)
    List<Contract> findByMemberIdAndStatusAndDateRange(
        @Param("memberId") Long memberId,
        @Param("status") ContractStatusEnum status,
        @Param("bookingDate") LocalDate bookingDate
    );
    
    /**
     * Find contracts for a member with specific status
     * Useful for filtering (e.g., show only ACTIVE contracts for a member)
     */
    List<Contract> findByMemberIdAndStatus(Long memberId, ContractStatusEnum status);
    
    /**
     * Find contracts for a PT with specific status
     * Useful for PT dashboard filtering
     */
    List<Contract> findByMainPtIdAndStatus(Long ptId, ContractStatusEnum status);
}
