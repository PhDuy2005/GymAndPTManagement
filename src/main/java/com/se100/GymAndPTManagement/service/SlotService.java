package com.se100.GymAndPTManagement.service;

import java.util.List;
import java.util.stream.Collectors;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.stereotype.Service;

import com.se100.GymAndPTManagement.domain.requestDTO.ReqCreateSlotDTO;
import com.se100.GymAndPTManagement.domain.requestDTO.ReqUpdateSlotDTO;
import com.se100.GymAndPTManagement.domain.responseDTO.ResSlotDTO;
import com.se100.GymAndPTManagement.domain.responseDTO.ResultPaginationDTO;
import com.se100.GymAndPTManagement.domain.table.Slot;
import com.se100.GymAndPTManagement.repository.SlotRepository;
import com.se100.GymAndPTManagement.util.error.IdInvalidException;

import lombok.RequiredArgsConstructor;

/**
 * Generated by: GitHub Copilot (Claude Sonnet 4.5)
 * Created by: PhDuy2005
 * Created at: 2026-01-13 23:53:21
 * Purpose: Service for Slot entity
 */
@Service
@RequiredArgsConstructor
public class SlotService {

    private final SlotRepository slotRepository;

    public ResSlotDTO createSlot(ReqCreateSlotDTO request) {
        // Validate time logic
        if (request.getStartTime().isAfter(request.getEndTime()) ||
                request.getStartTime().equals(request.getEndTime())) {
            throw new IllegalArgumentException("Start time must be before end time");
        }

        Slot slot = Slot.builder()
                .slotName(request.getSlotName())
                .startTime(request.getStartTime())
                .endTime(request.getEndTime())
                .isActive(true)
                .build();

        Slot savedSlot = slotRepository.save(slot);
        return ResSlotDTO.fromEntity(savedSlot);
    }

    public List<ResSlotDTO> getAllSlots() {
        return slotRepository.findAll().stream()
                .map(ResSlotDTO::fromEntity)
                .collect(Collectors.toList());
    }

    public ResSlotDTO getSlotById(Long id) {
        Slot slot = slotRepository.findById(id)
                .orElseThrow(() -> new IdInvalidException("Slot not found with id: " + id));
        return ResSlotDTO.fromEntity(slot);
    }

    public ResSlotDTO updateSlot(Long id, ReqUpdateSlotDTO request) {
        Slot slot = slotRepository.findById(id)
                .orElseThrow(() -> new IdInvalidException("Slot not found with id: " + id));

        // Validate time logic
        if (request.getStartTime().isAfter(request.getEndTime()) ||
                request.getStartTime().equals(request.getEndTime())) {
            throw new IllegalArgumentException("Start time must be before end time");
        }

        slot.setSlotName(request.getSlotName());
        slot.setStartTime(request.getStartTime());
        slot.setEndTime(request.getEndTime());

        Slot updatedSlot = slotRepository.save(slot);
        return ResSlotDTO.fromEntity(updatedSlot);
    }

    public void deleteSlot(Long id) {
        Slot slot = slotRepository.findById(id)
                .orElseThrow(() -> new IdInvalidException("Slot not found with id: " + id));
        slot.setIsActive(false);
        slotRepository.save(slot);
    }

    public List<ResSlotDTO> getAllActiveSlots() {
        return slotRepository.findByIsActive(true).stream()
                .map(ResSlotDTO::fromEntity)
                .collect(Collectors.toList());
    }

    public ResSlotDTO activateSlot(Long id) {
        Slot slot = slotRepository.findById(id)
                .orElseThrow(() -> new IdInvalidException("Slot not found with id: " + id));
        slot.setIsActive(true);
        Slot activatedSlot = slotRepository.save(slot);
        return ResSlotDTO.fromEntity(activatedSlot);
    }

    public ResultPaginationDTO handleFetchSlots(Specification<Slot> specification, Pageable pageable) {
        Page<Slot> slotPage = slotRepository.findAll(specification, pageable);

        ResultPaginationDTO result = new ResultPaginationDTO();
        ResultPaginationDTO.Meta meta = new ResultPaginationDTO.Meta();

        meta.setPage(pageable.getPageNumber() + 1);
        meta.setPageSize(pageable.getPageSize());
        meta.setTotalPages(slotPage.getTotalPages());
        meta.setTotalItems(slotPage.getTotalElements());

        result.setMeta(meta);

        List<ResSlotDTO> slotDTOs = slotPage.getContent().stream()
                .map(ResSlotDTO::fromEntity)
                .collect(Collectors.toList());

        result.setResult(slotDTOs);

        return result;
    }
}
