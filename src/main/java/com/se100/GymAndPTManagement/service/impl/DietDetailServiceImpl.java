/**
 * Generated by: GitHub Copilot (Claude Sonnet 4.5)
 * Created by: Danh
 * Created at: 2026-01-10 14:05:17
 * Purpose: DietDetail service implementation with business logic
 */

package com.se100.GymAndPTManagement.service.impl;

import com.se100.GymAndPTManagement.domain.requestDTO.ReqDietDetailDTO;
import com.se100.GymAndPTManagement.domain.responseDTO.ResDietDetailDTO;
import com.se100.GymAndPTManagement.domain.table.DietDetail;
import com.se100.GymAndPTManagement.domain.table.DietDetailId;
import com.se100.GymAndPTManagement.repository.DietDetailRepository;
import com.se100.GymAndPTManagement.service.DietDetailService;
import com.se100.GymAndPTManagement.util.error.IdInvalidException;
import lombok.AllArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.stream.Collectors;

@Service
@AllArgsConstructor
public class DietDetailServiceImpl implements DietDetailService {
    
    private final DietDetailRepository dietDetailRepository;
    
    @Override
    public ResDietDetailDTO addFoodToDiet(ReqDietDetailDTO reqDietDetailDTO) {
        // Kiểm tra thực phẩm đã có trong kế hoạch ăn chưa
        DietDetailId dietDetailId = DietDetailId.builder()
                .dailyDietId(reqDietDetailDTO.getDailyDietId())
                .foodId(reqDietDetailDTO.getFoodId())
                .build();
        
        if (dietDetailRepository.existsById(dietDetailId)) {
            throw new IdInvalidException("Thực phẩm này đã có trong kế hoạch ăn");
        }
        
        DietDetail dietDetail = DietDetail.builder()
                .dailyDietId(reqDietDetailDTO.getDailyDietId())
                .foodId(reqDietDetailDTO.getFoodId())
                .quantity(reqDietDetailDTO.getQuantity())
                .mealType(reqDietDetailDTO.getMealType())
                .build();
        
        DietDetail savedDietDetail = dietDetailRepository.save(dietDetail);
        return convertToDTO(savedDietDetail);
    }
    
    @Override
    public ResDietDetailDTO updateDietDetail(Long dailyDietId, Long foodId, ReqDietDetailDTO reqDietDetailDTO) {
        DietDetailId dietDetailId = DietDetailId.builder()
                .dailyDietId(dailyDietId)
                .foodId(foodId)
                .build();
        
        DietDetail dietDetail = dietDetailRepository.findById(dietDetailId)
                .orElseThrow(() -> new IdInvalidException("Chi tiết kế hoạch ăn không tồn tại"));
        
        dietDetail.setQuantity(reqDietDetailDTO.getQuantity());
        dietDetail.setMealType(reqDietDetailDTO.getMealType());
        
        DietDetail updatedDietDetail = dietDetailRepository.save(dietDetail);
        return convertToDTO(updatedDietDetail);
    }
    
    @Override
    public List<ResDietDetailDTO> getFoodsByDailyDiet(Long dailyDietId) {
        return dietDetailRepository.findByDailyDietId(dailyDietId).stream()
                .map(this::convertToDTO)
                .collect(Collectors.toList());
    }
    
    @Override
    public List<ResDietDetailDTO> getFoodsByMealType(Long dailyDietId, String mealType) {
        return dietDetailRepository.findByDailyDietIdAndMealType(dailyDietId, mealType).stream()
                .map(this::convertToDTO)
                .collect(Collectors.toList());
    }
    
    @Override
    public void removeFoodFromDiet(Long dailyDietId, Long foodId) {
        DietDetailId dietDetailId = DietDetailId.builder()
                .dailyDietId(dailyDietId)
                .foodId(foodId)
                .build();
        
        if (!dietDetailRepository.existsById(dietDetailId)) {
            throw new IdInvalidException("Chi tiết kế hoạch ăn không tồn tại");
        }
        
        dietDetailRepository.deleteById(dietDetailId);
    }
    
    // Helper method
    private ResDietDetailDTO convertToDTO(DietDetail dietDetail) {
        return ResDietDetailDTO.builder()
                .dailyDietId(dietDetail.getDailyDietId())
                .foodId(dietDetail.getFoodId())
                .quantity(dietDetail.getQuantity())
                .mealType(dietDetail.getMealType())
                .build();
    }
}






