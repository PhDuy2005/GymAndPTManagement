package com.se100.GymAndPTManagement.service;

import java.math.BigDecimal;
import java.util.List;
import java.util.NoSuchElementException;
import java.util.logging.Logger;
import java.util.stream.Collectors;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.se100.GymAndPTManagement.domain.requestDTO.ReqCreateDietDetailDTO;
import com.se100.GymAndPTManagement.domain.requestDTO.ReqUpdateDietDetailDTO;
import com.se100.GymAndPTManagement.domain.responseDTO.ResDietDetailDTO;
import com.se100.GymAndPTManagement.domain.responseDTO.ResultPaginationDTO;
import com.se100.GymAndPTManagement.domain.table.DailyDiet;
import com.se100.GymAndPTManagement.domain.table.DietDetail;
import com.se100.GymAndPTManagement.domain.table.DietDetailId;
import com.se100.GymAndPTManagement.domain.table.Food;
import com.se100.GymAndPTManagement.repository.DailyDietRepository;
import com.se100.GymAndPTManagement.repository.DietDetailRepository;
import com.se100.GymAndPTManagement.repository.FoodRepository;

/**
 * Generated by: GitHub Copilot (Claude Sonnet 4.5)
 * Created by: PhDuy2005
 * Created at: 2026-01-15 17:00:00
 * Purpose: DietDetail service for business logic
 */
@Service
public class DietDetailService {

    private final DietDetailRepository dietDetailRepository;
    private final DailyDietRepository dailyDietRepository;
    private final FoodRepository foodRepository;
    Logger logger = Logger.getLogger(DietDetailService.class.getName());

    public DietDetailService(DietDetailRepository dietDetailRepository,
            DailyDietRepository dailyDietRepository,
            FoodRepository foodRepository) {
        this.dietDetailRepository = dietDetailRepository;
        this.dailyDietRepository = dailyDietRepository;
        this.foodRepository = foodRepository;
    }

    // =========================================
    // Conversion Helpers
    // =========================================

    private ResDietDetailDTO convertToDTO(DietDetail dietDetail) {
        Food food = dietDetail.getFood();
        BigDecimal amount = dietDetail.getAmount() != null ? dietDetail.getAmount() : BigDecimal.ZERO;

        // Calculate total nutrition based on amount
        // Formula: total = (nutritionPer100g / 100) * amount
        BigDecimal totalCalories = food.getCalories() != null
                ? food.getCalories().divide(BigDecimal.valueOf(100), 2, java.math.RoundingMode.HALF_UP)
                        .multiply(amount)
                : null;

        BigDecimal totalProtein = food.getProtein() != null
                ? food.getProtein().divide(BigDecimal.valueOf(100), 2, java.math.RoundingMode.HALF_UP)
                        .multiply(amount)
                : null;

        BigDecimal totalCarbs = food.getCarbohydrate() != null
                ? food.getCarbohydrate().divide(BigDecimal.valueOf(100), 2, java.math.RoundingMode.HALF_UP)
                        .multiply(amount)
                : null;

        BigDecimal totalFat = food.getFat() != null
                ? food.getFat().divide(BigDecimal.valueOf(100), 2, java.math.RoundingMode.HALF_UP)
                        .multiply(amount)
                : null;

        return ResDietDetailDTO.builder()
                .dietId(dietDetail.getDietId())
                .foodId(dietDetail.getFoodId())
                .foodName(food.getName())
                .prepMethod(dietDetail.getPrepMethod())
                .amount(dietDetail.getAmount())
                .note(dietDetail.getNote())
                // Nutrition per 100g from food
                .caloriesPer100g(food.getCalories())
                .proteinPer100g(food.getProtein())
                .carbsPer100g(food.getCarbohydrate())
                .fatPer100g(food.getFat())
                // Calculated total nutrition
                .totalCalories(totalCalories)
                .totalProteinG(totalProtein)
                .totalCarbsG(totalCarbs)
                .totalFatG(totalFat)
                .createdAt(dietDetail.getCreatedAt())
                .updatedAt(dietDetail.getUpdatedAt())
                .build();
    }

    // =========================================
    // CRUD Methods
    // =========================================

    /**
     * Add food to daily diet
     * 
     * @param request DTO containing diet detail creation info
     * @return Response DTO with created diet detail data
     */
    @Transactional
    public ResDietDetailDTO addFoodToDiet(ReqCreateDietDetailDTO request) {
        // Validate daily diet exists
        DailyDiet dailyDiet = dailyDietRepository.findById(request.getDietId())
                .orElseThrow(() -> {
                    logger.warning(">>>DIET DETAIL SERVICE - ADD FOOD: Daily diet not found - ID: "
                            + request.getDietId());
                    return new NoSuchElementException("Không tìm thấy thực đơn với ID: " + request.getDietId());
                });

        // Validate food exists
        Food food = foodRepository.findById(request.getFoodId())
                .orElseThrow(() -> {
                    logger.warning(">>>DIET DETAIL SERVICE - ADD FOOD: Food not found - ID: " + request.getFoodId());
                    return new NoSuchElementException("Không tìm thấy thực phẩm với ID: " + request.getFoodId());
                });

        // Check if food already exists in this diet
        if (dietDetailRepository.existsByDietIdAndFoodId(request.getDietId(), request.getFoodId())) {
            logger.warning(">>>DIET DETAIL SERVICE - ADD FOOD: Food already exists in diet - Diet ID: "
                    + request.getDietId() + ", Food ID: " + request.getFoodId());
            throw new IllegalArgumentException("Thực phẩm này đã có trong thực đơn");
        }

        // Create diet detail
        DietDetail dietDetail = DietDetail.builder()
                .dietId(request.getDietId())
                .foodId(request.getFoodId())
                .dailyDiet(dailyDiet)
                .food(food)
                .prepMethod(request.getPrepMethod())
                .amount(request.getAmount())
                .note(request.getNote())
                .build();

        dietDetail = dietDetailRepository.save(dietDetail);
        logger.info(">>>DIET DETAIL SERVICE - ADD FOOD: Food added to diet successfully - Diet ID: "
                + request.getDietId() + ", Food ID: " + request.getFoodId());

        return convertToDTO(dietDetail);
    }

    /**
     * Get diet detail by composite key
     * 
     * @param dietId Diet ID
     * @param foodId Food ID
     * @return Response DTO with diet detail data
     */
    public ResDietDetailDTO getDietDetail(Long dietId, Long foodId) {
        DietDetailId id = new DietDetailId(dietId, foodId);
        DietDetail dietDetail = dietDetailRepository.findById(id)
                .orElseThrow(() -> {
                    logger.warning(">>>DIET DETAIL SERVICE - GET: Diet detail not found - Diet ID: " + dietId
                            + ", Food ID: " + foodId);
                    return new NoSuchElementException("Không tìm thấy chi tiết thực đơn");
                });

        return convertToDTO(dietDetail);
    }

    /**
     * Get all diet details for a specific daily diet
     * 
     * @param dietId Diet ID
     * @return List of diet details
     */
    public List<ResDietDetailDTO> getDietDetailsByDiet(Long dietId) {
        return dietDetailRepository.findByDietId(dietId).stream()
                .map(this::convertToDTO)
                .collect(Collectors.toList());
    }

    /**
     * Get diet details for a specific daily diet with pagination
     * 
     * @param dietId   Diet ID
     * @param pageable Pagination info
     * @return Paginated result
     */
    public ResultPaginationDTO getDietDetailsByDietPaginated(Long dietId, Pageable pageable) {
        Page<DietDetail> detailPage = dietDetailRepository.findByDietId(dietId, pageable);

        ResultPaginationDTO.Meta meta = ResultPaginationDTO.Meta.builder()
                .page(pageable.getPageNumber() + 1)
                .pageSize(pageable.getPageSize())
                .totalPages(detailPage.getTotalPages())
                .totalItems(detailPage.getTotalElements())
                .build();

        List<ResDietDetailDTO> detailDTOs = detailPage.getContent().stream()
                .map(this::convertToDTO)
                .collect(Collectors.toList());

        ResultPaginationDTO res = new ResultPaginationDTO();
        res.setMeta(meta);
        res.setResult(detailDTOs);
        return res;
    }

    /**
     * Get all diet details with filter and pagination
     * 
     * @param spec     Specification filter
     * @param pageable Pagination info
     * @return Paginated result
     */
    public ResultPaginationDTO handleFetchDietDetails(Specification<DietDetail> spec, Pageable pageable) {
        Page<DietDetail> detailPage = dietDetailRepository.findAll(spec, pageable);

        ResultPaginationDTO.Meta meta = ResultPaginationDTO.Meta.builder()
                .page(pageable.getPageNumber() + 1)
                .pageSize(pageable.getPageSize())
                .totalPages(detailPage.getTotalPages())
                .totalItems(detailPage.getTotalElements())
                .build();

        List<ResDietDetailDTO> detailDTOs = detailPage.getContent().stream()
                .map(this::convertToDTO)
                .collect(Collectors.toList());

        ResultPaginationDTO res = new ResultPaginationDTO();
        res.setMeta(meta);
        res.setResult(detailDTOs);
        return res;
    }

    /**
     * Get all diets containing a specific food
     * 
     * @param foodId   Food ID
     * @param pageable Pagination info
     * @return Paginated result
     */
    public ResultPaginationDTO getDietDetailsByFood(Long foodId, Pageable pageable) {
        Page<DietDetail> detailPage = dietDetailRepository.findByFoodId(foodId, pageable);

        ResultPaginationDTO.Meta meta = ResultPaginationDTO.Meta.builder()
                .page(pageable.getPageNumber() + 1)
                .pageSize(pageable.getPageSize())
                .totalPages(detailPage.getTotalPages())
                .totalItems(detailPage.getTotalElements())
                .build();

        List<ResDietDetailDTO> detailDTOs = detailPage.getContent().stream()
                .map(this::convertToDTO)
                .collect(Collectors.toList());

        ResultPaginationDTO res = new ResultPaginationDTO();
        res.setMeta(meta);
        res.setResult(detailDTOs);
        return res;
    }

    /**
     * Update diet detail
     * 
     * @param dietId  Diet ID
     * @param foodId  Food ID
     * @param request DTO containing update data
     * @return Response DTO with updated diet detail data
     */
    @Transactional
    public ResDietDetailDTO updateDietDetail(Long dietId, Long foodId, ReqUpdateDietDetailDTO request) {
        DietDetailId id = new DietDetailId(dietId, foodId);
        DietDetail dietDetail = dietDetailRepository.findById(id)
                .orElseThrow(() -> {
                    logger.warning(">>>DIET DETAIL SERVICE - UPDATE: Diet detail not found - Diet ID: " + dietId
                            + ", Food ID: " + foodId);
                    return new NoSuchElementException("Không tìm thấy chi tiết thực đơn");
                });

        // Update fields if provided
        if (request.getPrepMethod() != null) {
            dietDetail.setPrepMethod(request.getPrepMethod());
        }

        if (request.getAmount() != null) {
            dietDetail.setAmount(request.getAmount());
        }

        if (request.getNote() != null) {
            dietDetail.setNote(request.getNote());
        }

        dietDetail = dietDetailRepository.save(dietDetail);
        logger.info(">>>DIET DETAIL SERVICE - UPDATE: Diet detail updated successfully - Diet ID: " + dietId
                + ", Food ID: " + foodId);

        return convertToDTO(dietDetail);
    }

    /**
     * Remove food from daily diet
     * 
     * @param dietId Diet ID
     * @param foodId Food ID
     */
    @Transactional
    public void removeFoodFromDiet(Long dietId, Long foodId) {
        DietDetailId id = new DietDetailId(dietId, foodId);
        if (!dietDetailRepository.existsById(id)) {
            logger.warning(">>>DIET DETAIL SERVICE - DELETE: Diet detail not found - Diet ID: " + dietId
                    + ", Food ID: " + foodId);
            throw new NoSuchElementException("Không tìm thấy chi tiết thực đơn");
        }

        dietDetailRepository.deleteById(id);
        logger.info(">>>DIET DETAIL SERVICE - DELETE: Food removed from diet successfully - Diet ID: " + dietId
                + ", Food ID: " + foodId);
    }

    /**
     * Remove all foods from daily diet
     * 
     * @param dietId Diet ID
     */
    @Transactional
    public void removeAllFoodsFromDiet(Long dietId) {
        if (!dailyDietRepository.existsById(dietId)) {
            logger.warning(">>>DIET DETAIL SERVICE - DELETE ALL: Daily diet not found - ID: " + dietId);
            throw new NoSuchElementException("Không tìm thấy thực đơn với ID: " + dietId);
        }

        long count = dietDetailRepository.countByDietId(dietId);
        dietDetailRepository.deleteByDietId(dietId);
        logger.info(">>>DIET DETAIL SERVICE - DELETE ALL: All foods removed from diet - Diet ID: " + dietId
                + ", Count: " + count);
    }
}
