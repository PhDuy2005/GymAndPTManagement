package com.se100.GymAndPTManagement.service;

import java.util.List;
import java.util.stream.Collectors;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.se100.GymAndPTManagement.domain.requestDTO.ReqCreateServicePackageDTO;
import com.se100.GymAndPTManagement.domain.requestDTO.ReqUpdateServicePackageDTO;
import com.se100.GymAndPTManagement.domain.responseDTO.ResServicePackageDTO;
import com.se100.GymAndPTManagement.domain.responseDTO.ResultPaginationDTO;
import com.se100.GymAndPTManagement.domain.table.ServicePackage;
import com.se100.GymAndPTManagement.repository.ServicePackageRepository;
import com.se100.GymAndPTManagement.util.enums.PackageTypeEnum;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

/**
 * Generated by: GitHub Copilot (Claude Sonnet 4.5)
 * Created by: PhDuy2005
 * Created at: 2026-01-11 09:30:43
 * Purpose: Service layer for ServicePackage business logic
 */
@Service
@Slf4j
@RequiredArgsConstructor
public class ServicePackageService {

    private final ServicePackageRepository servicePackageRepository;

    /**
     * Create new service package
     */
    @Transactional
    public ResServicePackageDTO createServicePackage(ReqCreateServicePackageDTO request) {
        // Check if package name already exists
        if (servicePackageRepository.existsByPackageName(request.getPackageName())) {
            throw new IllegalArgumentException("Package name already exists: " + request.getPackageName());
        }

        ServicePackage servicePackage = ServicePackage.builder()
                .packageName(request.getPackageName())
                .price(request.getPrice())
                .type(request.getType())
                .isActive(request.getIsActive() != null ? request.getIsActive() : true)
                .description(request.getDescription())
                .durationInDays(request.getDurationInDays())
                .numberOfSessions(request.getNumberOfSessions())
                .build();

        ServicePackage savedPackage = servicePackageRepository.save(servicePackage);
        return ResServicePackageDTO.fromEntity(savedPackage);
    }

    /**
     * Get all service packages
     */
    @Transactional(readOnly = true)
    public List<ResServicePackageDTO> getAllServicePackages() {
        return servicePackageRepository.findAll().stream()
                .map(ResServicePackageDTO::fromEntity)
                .collect(Collectors.toList());
    }

    /**
     * Fetch service packages with pagination and filter
     */
    @Transactional(readOnly = true)
    public ResultPaginationDTO handleFetchServicePackages(Specification<ServicePackage> specification,
            Pageable pageable) {
        Page<ServicePackage> pageServicePackages = servicePackageRepository.findAll(specification, pageable);
        ResultPaginationDTO resultPaginationDTO = new ResultPaginationDTO();
        ResultPaginationDTO.Meta meta = ResultPaginationDTO.Meta.builder()
                .page(pageable.getPageNumber() + 1)
                .pageSize(pageable.getPageSize())
                .totalPages(pageServicePackages.getTotalPages())
                .totalItems(pageServicePackages.getTotalElements())
                .build();

        resultPaginationDTO.setMeta(meta);
        List<ResServicePackageDTO> result = pageServicePackages.getContent()
                .stream()
                .map(ResServicePackageDTO::fromEntity)
                .collect(Collectors.toList());
        resultPaginationDTO.setResult(result);
        return resultPaginationDTO;
    }

    /**
     * Get all active service packages
     */
    @Transactional(readOnly = true)
    public List<ResServicePackageDTO> getAllActiveServicePackages() {
        return servicePackageRepository.findByIsActive(true).stream()
                .map(ResServicePackageDTO::fromEntity)
                .collect(Collectors.toList());
    }

    /**
     * Get service packages by type
     */
    @Transactional(readOnly = true)
    public List<ResServicePackageDTO> getServicePackagesByType(PackageTypeEnum type) {
        return servicePackageRepository.findByType(type).stream()
                .map(ResServicePackageDTO::fromEntity)
                .collect(Collectors.toList());
    }

    /**
     * Get active service packages by type
     */
    @Transactional(readOnly = true)
    public List<ResServicePackageDTO> getActiveServicePackagesByType(PackageTypeEnum type) {
        return servicePackageRepository.findByTypeAndIsActive(type, true).stream()
                .map(ResServicePackageDTO::fromEntity)
                .collect(Collectors.toList());
    }

    /**
     * Get service package by ID
     */
    @Transactional(readOnly = true)
    public ResServicePackageDTO getServicePackageById(Long id) {
        ServicePackage servicePackage = servicePackageRepository.findById(id)
                .orElseThrow(() -> new IllegalArgumentException("Service package not found with ID: " + id));
        return ResServicePackageDTO.fromEntity(servicePackage);
    }

    /**
     * Get service package by name
     */
    @Transactional(readOnly = true)
    public ResServicePackageDTO getServicePackageByName(String packageName) {
        ServicePackage servicePackage = servicePackageRepository.findByPackageName(packageName)
                .orElseThrow(() -> new IllegalArgumentException("Service package not found with name: " + packageName));
        return ResServicePackageDTO.fromEntity(servicePackage);
    }

    /**
     * Update service package
     */
    @Transactional
    public ResServicePackageDTO updateServicePackage(Long id, ReqUpdateServicePackageDTO request) {
        ServicePackage servicePackage = servicePackageRepository.findById(id)
                .orElseThrow(() -> new IllegalArgumentException("Service package not found with ID: " + id));

        // Check if new package name already exists (excluding current package)
        if (request.getPackageName() != null && !request.getPackageName().equals(servicePackage.getPackageName())) {
            if (servicePackageRepository.existsByPackageName(request.getPackageName())) {
                throw new IllegalArgumentException("Package name already exists: " + request.getPackageName());
            }
            servicePackage.setPackageName(request.getPackageName());
        }

        if (request.getPrice() != null) {
            servicePackage.setPrice(request.getPrice());
        }

        if (request.getType() != null) {
            servicePackage.setType(request.getType());
        }

        if (request.getIsActive() != null) {
            servicePackage.setIsActive(request.getIsActive());
        }

        if (request.getDescription() != null) {
            servicePackage.setDescription(request.getDescription());
        }

        if (request.getDurationInDays() != null) {
            servicePackage.setDurationInDays(request.getDurationInDays());
        }

        if (request.getNumberOfSessions() != null) {
            servicePackage.setNumberOfSessions(request.getNumberOfSessions());
        }

        ServicePackage updatedPackage = servicePackageRepository.save(servicePackage);
        return ResServicePackageDTO.fromEntity(updatedPackage);
    }

    /**
     * Delete service package (soft delete by setting isActive to false)
     */
    @Transactional
    public void deleteServicePackage(Long id) {
        ServicePackage servicePackage = servicePackageRepository.findById(id)
                .orElseThrow(() -> new IllegalArgumentException("Service package not found with ID: " + id));

        servicePackage.setIsActive(false);
        servicePackageRepository.save(servicePackage);
    }

    /**
     * Activate service package
     */
    @Transactional
    public ResServicePackageDTO activateServicePackage(Long id) {
        ServicePackage servicePackage = servicePackageRepository.findById(id)
                .orElseThrow(() -> new IllegalArgumentException("Service package not found with ID: " + id));

        servicePackage.setIsActive(true);
        ServicePackage updatedPackage = servicePackageRepository.save(servicePackage);
        return ResServicePackageDTO.fromEntity(updatedPackage);
    }

    /**
     * Deactivate service package
     */
    @Transactional
    public ResServicePackageDTO deactivateServicePackage(Long id) {
        ServicePackage servicePackage = servicePackageRepository.findById(id)
                .orElseThrow(() -> new IllegalArgumentException("Service package not found with ID: " + id));

        servicePackage.setIsActive(false);
        ServicePackage updatedPackage = servicePackageRepository.save(servicePackage);
        return ResServicePackageDTO.fromEntity(updatedPackage);
    }
}
