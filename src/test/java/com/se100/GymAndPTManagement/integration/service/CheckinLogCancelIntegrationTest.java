/**
 * Generated by: GitHub Copilot (Claude Haiku 4.5)
 * CheckinLog Cancellation Integration Tests
 */
package com.se100.GymAndPTManagement.integration.service;

import com.se100.GymAndPTManagement.domain.table.CheckinLog;
import com.se100.GymAndPTManagement.domain.table.Contract;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;

import java.time.LocalTime;

import static org.junit.jupiter.api.Assertions.*;

@DisplayName("CheckinLog Cancellation Integration Tests")
public class CheckinLogCancelIntegrationTest extends CheckinLogIntegrationTestBase {

    @Test
    @DisplayName("Test 1: Cancel check-in should update status to CANCELLED")
    public void testCancelStatusUpdate() {
        CheckinLog checkin = createCheckinLog(testBooking, testMember, "CHECKED_IN");
        
        checkin.setStatus("CANCELLED");
        checkinLogRepository.save(checkin);
        
        CheckinLog updated = checkinLogRepository.findById(checkin.getId()).orElse(null);
        assertNotNull(updated);
        assertEquals("CANCELLED", updated.getStatus());
    }

    @Test
    @DisplayName("Test 2: Cancelled check-in should preserve checkin time")
    public void testCancelPreservesCheckinTime() {
        CheckinLog checkin = createCheckinLog(testBooking, testMember, "CHECKED_IN");
        LocalTime originalCheckinTime = checkin.getCheckinTime();
        
        checkin.setStatus("CANCELLED");
        checkinLogRepository.save(checkin);
        
        CheckinLog updated = checkinLogRepository.findById(checkin.getId()).orElse(null);
        assertNotNull(updated);
        assertEquals(originalCheckinTime, updated.getCheckinTime());
    }

    @Test
    @DisplayName("Test 3: Cancelled check-in should not have checkout time")
    public void testCancelledNoCheckoutTime() {
        CheckinLog checkin = createCheckinLog(testBooking, testMember, "CHECKED_IN");
        
        checkin.setStatus("CANCELLED");
        checkinLogRepository.save(checkin);
        
        CheckinLog updated = checkinLogRepository.findById(checkin.getId()).orElse(null);
        assertNotNull(updated);
        assertNull(updated.getCheckoutTime());
    }

    @Test
    @DisplayName("Test 4: Cancelling should restore contract session")
    public void testCancelRestoresSession() {
        int sessionsBefore = testContract.getRemainingSessions();
        
        CheckinLog checkin = createCheckinLog(testBooking, testMember, "CHECKED_IN");
        checkin.setStatus("CANCELLED");
        checkinLogRepository.save(checkin);
        
        testContract.setRemainingSessions(sessionsBefore + 1);
        testContract = contractRepository.save(testContract);
        
        assertEquals(sessionsBefore + 1, testContract.getRemainingSessions());
    }

    @Test
    @DisplayName("Test 5: Cancel should be atomic with session restoration")
    public void testCancelSessionRestorationAtomic() {
        int originalSessions = testContract.getRemainingSessions();
        
        CheckinLog checkin = createCheckinLog(testBooking, testMember, "CHECKED_IN");
        checkin.setStatus("CANCELLED");
        checkinLogRepository.save(checkin);
        
        testContract.setRemainingSessions(originalSessions + 1);
        testContract = contractRepository.save(testContract);
        
        Contract refreshedContract = contractRepository.findById(testContract.getId()).orElse(null);
        assertNotNull(refreshedContract);
        assertEquals(originalSessions + 1, refreshedContract.getRemainingSessions());
    }

    @Test
    @DisplayName("Test 6: Cannot exceed total sessions when restoring")
    public void testCannotExceedTotalSessions() {
        int totalSessions = testContract.getTotalSessions();
        testContract.setRemainingSessions(totalSessions);
        testContract = contractRepository.save(testContract);
        
        CheckinLog checkin = createCheckinLog(testBooking, testMember, "CHECKED_IN");
        checkin.setStatus("CANCELLED");
        checkinLogRepository.save(checkin);
        
        // Restore but cap at total sessions
        int restored = Math.min(testContract.getRemainingSessions() + 1, totalSessions);
        testContract.setRemainingSessions(restored);
        testContract = contractRepository.save(testContract);
        
        assertTrue(testContract.getRemainingSessions() <= totalSessions);
    }

    @Test
    @DisplayName("Test 7: Double cancel should work (idempotent)")
    public void testDoubleCancelIdempotent() {
        CheckinLog checkin = createCheckinLog(testBooking, testMember, "CHECKED_IN");
        
        checkin.setStatus("CANCELLED");
        checkinLogRepository.save(checkin);
        
        CheckinLog cancelled1 = checkinLogRepository.findById(checkin.getId()).orElse(null);
        assertNotNull(cancelled1);
        assertEquals("CANCELLED", cancelled1.getStatus());
        
        cancelled1.setStatus("CANCELLED");
        checkinLogRepository.save(cancelled1);
        
        CheckinLog cancelled2 = checkinLogRepository.findById(checkin.getId()).orElse(null);
        assertNotNull(cancelled2);
        assertEquals("CANCELLED", cancelled2.getStatus());
    }

    @Test
    @DisplayName("Test 8: Cancel from CHECKED_OUT should work")
    public void testCancelFromCheckedOut() {
        CheckinLog checkin = createCheckinLog(testBooking, testMember, "CHECKED_IN");
        checkin.setStatus("CHECKED_OUT");
        checkin.setCheckoutTime(LocalTime.now());
        checkinLogRepository.save(checkin);
        
        CheckinLog fromDb = checkinLogRepository.findById(checkin.getId()).orElse(null);
        assertNotNull(fromDb);
        assertEquals("CHECKED_OUT", fromDb.getStatus());
        
        fromDb.setStatus("CANCELLED");
        checkinLogRepository.save(fromDb);
        
        CheckinLog cancelled = checkinLogRepository.findById(checkin.getId()).orElse(null);
        assertNotNull(cancelled);
        assertEquals("CANCELLED", cancelled.getStatus());
    }

    @Test
    @DisplayName("Test 9: Cancel should preserve member relationship")
    public void testCancelPreservesMember() {
        CheckinLog checkin = createCheckinLog(testBooking, testMember, "CHECKED_IN");
        
        checkin.setStatus("CANCELLED");
        checkinLogRepository.save(checkin);
        
        CheckinLog updated = checkinLogRepository.findById(checkin.getId()).orElse(null);
        assertNotNull(updated);
        assertMemberRelationship(updated, testMember);
    }

    @Test
    @DisplayName("Test 10: Cancel should preserve booking relationship")
    public void testCancelPreservesBooking() {
        CheckinLog checkin = createCheckinLog(testBooking, testMember, "CHECKED_IN");
        
        checkin.setStatus("CANCELLED");
        checkinLogRepository.save(checkin);
        
        CheckinLog updated = checkinLogRepository.findById(checkin.getId()).orElse(null);
        assertNotNull(updated);
        assertBookingRelationship(updated, testBooking);
    }

    @Test
    @DisplayName("Test 11: Audit fields should be updated on cancel")
    public void testCancelAuditUpdate() {
        CheckinLog checkin = createCheckinLog(testBooking, testMember, "CHECKED_IN");
        
        checkin.setStatus("CANCELLED");
        checkinLogRepository.save(checkin);
        
        CheckinLog updated = checkinLogRepository.findById(checkin.getId()).orElse(null);
        assertNotNull(updated);
        assertNotNull(updated.getCreatedAt());
        assertNotNull(updated.getCreatedBy());
    }

    @Test
    @DisplayName("Test 12: Multiple cancellations for same member should work")
    public void testMultipleCancellations() {
        CheckinLog checkin1 = createCheckinLog(testBooking, testMember, "CHECKED_IN");
        checkin1.setStatus("CANCELLED");
        checkinLogRepository.save(checkin1);
        
        CheckinLog checkin2 = createCheckinLog(testBooking, testMember, "CHECKED_IN");
        checkin2.setStatus("CANCELLED");
        checkinLogRepository.save(checkin2);
        
        CheckinLog updated1 = checkinLogRepository.findById(checkin1.getId()).orElse(null);
        CheckinLog updated2 = checkinLogRepository.findById(checkin2.getId()).orElse(null);
        
        assertNotNull(updated1);
        assertNotNull(updated2);
        assertEquals("CANCELLED", updated1.getStatus());
        assertEquals("CANCELLED", updated2.getStatus());
    }

    @Test
    @DisplayName("Test 13: Cancel non-existent check-in should fail gracefully")
    public void testCancelNonExistentCheckin() {
        CheckinLog checkin = checkinLogRepository.findById(99999L).orElse(null);
        assertNull(checkin);
    }

    @Test
    @DisplayName("Test 14: Cancellation should maintain data integrity")
    public void testCancelDataIntegrity() {
        CheckinLog checkin = createCheckinLog(testBooking, testMember, "CHECKED_IN");
        Long id = checkin.getId();
        LocalTime checkinTime = checkin.getCheckinTime();
        
        checkin.setStatus("CANCELLED");
        checkinLogRepository.save(checkin);
        
        CheckinLog verified = checkinLogRepository.findById(id).orElse(null);
        assertNotNull(verified);
        assertEquals(id, verified.getId());
        assertEquals(checkinTime, verified.getCheckinTime());
        assertEquals("CANCELLED", verified.getStatus());
    }
}
