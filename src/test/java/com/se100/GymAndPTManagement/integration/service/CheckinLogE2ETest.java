/**
 * Generated by: GitHub Copilot (Claude Haiku 4.5)
 * CheckinLog E2E Integration Tests
 */
package com.se100.GymAndPTManagement.integration.service;

import com.se100.GymAndPTManagement.domain.table.CheckinLog;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;

import java.time.LocalTime;
import java.util.List;
import java.util.Optional;

import static org.junit.jupiter.api.Assertions.*;

@DisplayName("CheckinLog E2E Integration Tests")
public class CheckinLogE2ETest extends CheckinLogIntegrationTestBase {

    @Test
    @DisplayName("Test 1: Complete check-in workflow")
    public void testCompleteCheckinWorkflow() {
        // Create check-in
        CheckinLog checkin = createCheckinLog(testBooking, testMember, "CHECKED_IN");
        
        assertNotNull(checkin.getId());
        assertEquals("CHECKED_IN", checkin.getStatus());
        assertNotNull(checkin.getCheckinTime());
        assertNull(checkin.getCheckoutTime());
    }

    @Test
    @DisplayName("Test 2: Complete checkout workflow")
    public void testCompleteCheckoutWorkflow() {
        // Create check-in
        CheckinLog checkin = createCheckinLog(testBooking, testMember, "CHECKED_IN");
        
        // Checkout
        checkin.setStatus("CHECKED_OUT");
        checkin.setCheckoutTime(LocalTime.now());
        checkinLogRepository.save(checkin);
        
        // Verify checkout
        CheckinLog updated = checkinLogRepository.findById(checkin.getId()).orElse(null);
        assertNotNull(updated);
        assertEquals("CHECKED_OUT", updated.getStatus());
        assertNotNull(updated.getCheckoutTime());
    }

    @Test
    @DisplayName("Test 3: Complete cancellation workflow")
    public void testCompleteCancellationWorkflow() {
        // Create check-in
        CheckinLog checkin = createCheckinLog(testBooking, testMember, "CHECKED_IN");
        
        // Cancel
        checkin.setStatus("CANCELLED");
        checkinLogRepository.save(checkin);
        
        // Verify cancellation
        CheckinLog updated = checkinLogRepository.findById(checkin.getId()).orElse(null);
        assertNotNull(updated);
        assertEquals("CANCELLED", updated.getStatus());
    }

    @Test
    @DisplayName("Test 4: Query member check-ins")
    public void testQueryMemberCheckins() {
        // Create multiple check-ins
        createCheckinLog(testBooking, testMember, "CHECKED_IN");
        createCheckinLog(testBooking, testMember, "CHECKED_OUT");
        
        // Query
        List<CheckinLog> checkins = checkinLogRepository.findByMemberId(testMember.getId());
        
        assertTrue(checkins.size() >= 2);
    }

    @Test
    @DisplayName("Test 5: Query booking check-ins")
    public void testQueryBookingCheckins() {
        // Create multiple check-ins
        createCheckinLog(testBooking, testMember, "CHECKED_IN");
        createCheckinLog(testBooking, testMember, "CHECKED_IN");
        
        // Query
        List<CheckinLog> checkins = checkinLogRepository.findByBookingId(testBooking.getId());
        
        assertTrue(checkins.size() >= 2);
    }

    @Test
    @DisplayName("Test 6: Get single check-in by ID")
    public void testGetSingleCheckin() {
        // Create
        CheckinLog checkin = createCheckinLog(testBooking, testMember, "CHECKED_IN");
        
        // Get
        Optional<CheckinLog> found = checkinLogRepository.findById(checkin.getId());
        
        assertTrue(found.isPresent());
        assertEquals(checkin.getId(), found.get().getId());
    }

    @Test
    @DisplayName("Test 7: Calculate attendance rate")
    public void testCalculateAttendanceRate() {
        // Create sessions
        createCheckinLog(testBooking, testMember, "CHECKED_OUT");
        createCheckinLog(testBooking, testMember, "CHECKED_OUT");
        createCheckinLog(testBooking, testMember, "CHECKED_IN");
        
        // Query and calculate
        List<CheckinLog> logs = checkinLogRepository.findByMemberId(testMember.getId());
        long attended = logs.stream().filter(c -> "CHECKED_OUT".equals(c.getStatus())).count();
        long total = logs.size();
        
        double rate = (attended * 100.0) / total;
        assertEquals(66.666, rate, 0.01);
    }

    @Test
    @DisplayName("Test 8: Find active check-in")
    public void testFindActiveCheckin() {
        // Create check-in
        CheckinLog checkin = createCheckinLog(testBooking, testMember, "CHECKED_IN");
        
        // Find active
        Optional<CheckinLog> active = checkinLogRepository.findActiveCheckInByBookingId(testBooking.getId());
        
        assertTrue(active.isPresent());
        assertEquals("CHECKED_IN", active.get().getStatus());
    }

    @Test
    @DisplayName("Test 9: Error handling - no active check-in")
    public void testNoActiveCheckinError() {
        // Try to find active check-in that doesn't exist
        Optional<CheckinLog> active = checkinLogRepository.findActiveCheckInByBookingId(99999L);
        
        assertFalse(active.isPresent());
    }

    @Test
    @DisplayName("Test 10: Complete lifecycle workflow")
    public void testCompleteLifecycleWorkflow() {
        // Step 1: Create check-in
        CheckinLog checkin = createCheckinLog(testBooking, testMember, "CHECKED_IN");
        assertNotNull(checkin.getId());
        assertEquals("CHECKED_IN", checkin.getStatus());
        
        // Step 2: Verify check-in exists
        Optional<CheckinLog> found = checkinLogRepository.findById(checkin.getId());
        assertTrue(found.isPresent());
        
        // Step 3: Checkout
        checkin.setStatus("CHECKED_OUT");
        checkin.setCheckoutTime(LocalTime.now());
        checkinLogRepository.save(checkin);
        
        // Step 4: Verify checkout
        CheckinLog checkedOut = checkinLogRepository.findById(checkin.getId()).orElse(null);
        assertNotNull(checkedOut);
        assertEquals("CHECKED_OUT", checkedOut.getStatus());
        
        // Step 5: Cancel
        checkedOut.setStatus("CANCELLED");
        checkinLogRepository.save(checkedOut);
        
        // Step 6: Verify cancellation
        CheckinLog cancelled = checkinLogRepository.findById(checkin.getId()).orElse(null);
        assertNotNull(cancelled);
        assertEquals("CANCELLED", cancelled.getStatus());
        
        // Step 7: Query final state
        List<CheckinLog> logs = checkinLogRepository.findByMemberId(testMember.getId());
        assertTrue(logs.stream().anyMatch(c -> "CANCELLED".equals(c.getStatus())));
    }
}
