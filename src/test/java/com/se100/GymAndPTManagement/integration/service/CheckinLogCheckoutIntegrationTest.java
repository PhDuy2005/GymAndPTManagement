/**
 * Generated by: GitHub Copilot (Claude Haiku 4.5)
 * CheckinLog Checkout Integration Tests
 */
package com.se100.GymAndPTManagement.integration.service;

import com.se100.GymAndPTManagement.domain.table.CheckinLog;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;

import java.time.Instant;
import java.time.LocalTime;

import static org.junit.jupiter.api.Assertions.*;

@DisplayName("CheckinLog Checkout Integration Tests")
public class CheckinLogCheckoutIntegrationTest extends CheckinLogIntegrationTestBase {

    @Test
    @DisplayName("Test 1: Checkout should update status to CHECKED_OUT")
    public void testCheckoutStatusUpdate() {
        CheckinLog checkin = createCheckinLog(testBooking, testMember, "CHECKED_IN");
        
        checkin.setStatus("CHECKED_OUT");
        checkin.setCheckoutTime(LocalTime.now());
        checkinLogRepository.save(checkin);
        
        CheckinLog updated = checkinLogRepository.findById(checkin.getId()).orElse(null);
        assertNotNull(updated);
        assertEquals("CHECKED_OUT", updated.getStatus());
    }

    @Test
    @DisplayName("Test 2: Checkout time should be recorded")
    public void testCheckoutTimeRecorded() {
        CheckinLog checkin = createCheckinLog(testBooking, testMember, "CHECKED_IN");
        LocalTime checkoutTime = LocalTime.now();
        
        checkin.setStatus("CHECKED_OUT");
        checkin.setCheckoutTime(checkoutTime);
        checkinLogRepository.save(checkin);
        
        CheckinLog updated = checkinLogRepository.findById(checkin.getId()).orElse(null);
        assertNotNull(updated);
        assertCheckoutTimeSet(updated);
    }

    @Test
    @DisplayName("Test 3: Audit fields should be updated on checkout")
    public void testCheckoutAuditUpdate() {
        CheckinLog checkin = createCheckinLog(testBooking, testMember, "CHECKED_IN");
        Instant createdAt = checkin.getCreatedAt();
        
        checkin.setStatus("CHECKED_OUT");
        checkin.setCheckoutTime(LocalTime.now());
        checkinLogRepository.save(checkin);
        
        CheckinLog updated = checkinLogRepository.findById(checkin.getId()).orElse(null);
        assertNotNull(updated);
        assertEquals(createdAt, updated.getCreatedAt());
    }

    @Test
    @DisplayName("Test 4: Cannot checkout from CHECKED_OUT status")
    public void testDoubleCheckoutPrevention() {
        CheckinLog checkin = createCheckinLog(testBooking, testMember, "CHECKED_IN");
        
        checkin.setStatus("CHECKED_OUT");
        checkin.setCheckoutTime(LocalTime.now());
        checkinLogRepository.save(checkin);
        
        CheckinLog checkedOut = checkinLogRepository.findById(checkin.getId()).orElse(null);
        assertNotNull(checkedOut);
        assertEquals("CHECKED_OUT", checkedOut.getStatus());
    }

    @Test
    @DisplayName("Test 5: Checkout preserves member relationship")
    public void testCheckoutPreservesMember() {
        CheckinLog checkin = createCheckinLog(testBooking, testMember, "CHECKED_IN");
        
        checkin.setStatus("CHECKED_OUT");
        checkin.setCheckoutTime(LocalTime.now());
        checkinLogRepository.save(checkin);
        
        CheckinLog updated = checkinLogRepository.findById(checkin.getId()).orElse(null);
        assertNotNull(updated);
        assertMemberRelationship(updated, testMember);
    }

    @Test
    @DisplayName("Test 6: Checkout preserves booking relationship")
    public void testCheckoutPreservesBooking() {
        CheckinLog checkin = createCheckinLog(testBooking, testMember, "CHECKED_IN");
        
        checkin.setStatus("CHECKED_OUT");
        checkin.setCheckoutTime(LocalTime.now());
        checkinLogRepository.save(checkin);
        
        CheckinLog updated = checkinLogRepository.findById(checkin.getId()).orElse(null);
        assertNotNull(updated);
        assertBookingRelationship(updated, testBooking);
    }

    @Test
    @DisplayName("Test 7: Checkout time should be after checkin time")
    public void testCheckoutAfterCheckin() {
        CheckinLog checkin = createCheckinLog(testBooking, testMember, "CHECKED_IN");
        LocalTime checkinTime = checkin.getCheckinTime();
        LocalTime checkoutTime = checkinTime.plusHours(1);
        
        checkin.setStatus("CHECKED_OUT");
        checkin.setCheckoutTime(checkoutTime);
        checkinLogRepository.save(checkin);
        
        CheckinLog updated = checkinLogRepository.findById(checkin.getId()).orElse(null);
        assertNotNull(updated);
        assertTrue(updated.getCheckoutTime().isAfter(updated.getCheckinTime()));
    }

    @Test
    @DisplayName("Test 8: Cannot checkout from CANCELLED status")
    public void testCannotCheckoutFromCancelled() {
        CheckinLog checkin = createCheckinLog(testBooking, testMember, "CANCELLED");
        
        CheckinLog fromDb = checkinLogRepository.findById(checkin.getId()).orElse(null);
        assertNotNull(fromDb);
        assertEquals("CANCELLED", fromDb.getStatus());
    }

    @Test
    @DisplayName("Test 9: Session duration can be calculated")
    public void testSessionDurationCalculation() {
        CheckinLog checkin = createCheckinLog(testBooking, testMember, "CHECKED_IN");
        LocalTime checkinTime = LocalTime.of(6, 0);
        LocalTime checkoutTime = LocalTime.of(7, 0);
        
        checkin.setCheckinTime(checkinTime);
        checkin.setStatus("CHECKED_OUT");
        checkin.setCheckoutTime(checkoutTime);
        checkinLogRepository.save(checkin);
        
        CheckinLog updated = checkinLogRepository.findById(checkin.getId()).orElse(null);
        assertNotNull(updated);
        assertEquals(1, updated.getCheckoutTime().getHour() - updated.getCheckinTime().getHour());
    }

    @Test
    @DisplayName("Test 10: Multiple checkouts for same member should work")
    public void testMultipleCheckouts() {
        CheckinLog checkin1 = createCheckinLog(testBooking, testMember, "CHECKED_IN");
        checkin1.setStatus("CHECKED_OUT");
        checkin1.setCheckoutTime(LocalTime.now());
        checkinLogRepository.save(checkin1);
        
        CheckinLog checkin2 = createCheckinLog(testBooking, testMember, "CHECKED_IN");
        checkin2.setStatus("CHECKED_OUT");
        checkin2.setCheckoutTime(LocalTime.now().plusHours(2));
        checkinLogRepository.save(checkin2);
        
        CheckinLog updated1 = checkinLogRepository.findById(checkin1.getId()).orElse(null);
        CheckinLog updated2 = checkinLogRepository.findById(checkin2.getId()).orElse(null);
        
        assertNotNull(updated1);
        assertNotNull(updated2);
        assertEquals("CHECKED_OUT", updated1.getStatus());
        assertEquals("CHECKED_OUT", updated2.getStatus());
    }

    @Test
    @DisplayName("Test 11: Checkout should be persistent across queries")
    public void testCheckoutPersistence() {
        CheckinLog checkin = createCheckinLog(testBooking, testMember, "CHECKED_IN");
        
        checkin.setStatus("CHECKED_OUT");
        checkin.setCheckoutTime(LocalTime.now());
        checkinLogRepository.save(checkin);
        
        CheckinLog query1 = checkinLogRepository.findById(checkin.getId()).orElse(null);
        CheckinLog query2 = checkinLogRepository.findById(checkin.getId()).orElse(null);
        
        assertNotNull(query1);
        assertNotNull(query2);
        assertEquals(query1.getStatus(), query2.getStatus());
        assertEquals(query1.getCheckoutTime(), query2.getCheckoutTime());
    }

    @Test
    @DisplayName("Test 12: Checkout audit trail should be preserved")
    public void testCheckoutAuditTrail() {
        CheckinLog checkin = createCheckinLog(testBooking, testMember, "CHECKED_IN");
        String createdBy = checkin.getCreatedBy();
        
        checkin.setStatus("CHECKED_OUT");
        checkin.setCheckoutTime(LocalTime.now());
        checkinLogRepository.save(checkin);
        
        CheckinLog updated = checkinLogRepository.findById(checkin.getId()).orElse(null);
        assertNotNull(updated);
        assertEquals(createdBy, updated.getCreatedBy());
    }
}
