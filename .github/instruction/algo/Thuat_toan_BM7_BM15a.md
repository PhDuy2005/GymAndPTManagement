<!--
 * Generated by: GitHub Copilot (Claude Sonnet 4.5)
 * Created by: Danh
 * Created at: 2026-01-03 15:40:00
 * Purpose: Detailed algorithms and business logic for gym management system (BM7-BM15a)
-->
 ## BM7 – THÔNG TIN HỘI VIÊN
  
B1: Nhận thông tin hội viên (Họ tên, CCCD, DOB, Email, SĐT)
B2: Kết nối CSDL
B3: Kiểm tra Email hoặc SĐT đã tồn tại trong CSDL chưa
- Nếu đã tồn tại → thông báo lỗi (vi phạm QĐ 4) → đến B8
B4: Tạo mới hội viên trong bảng Customers
B5: Truy vấn các bảng liên quan:
- Danh sách gói đã/đang sử dụng
- Tổng tiền đã chi tiêu
- Tiền nợ hiện tại
B6: Hiển thị đầy đủ thông tin hội viên (BM7)
B7: Đóng kết nối CSDL
B9: Kết thúc


┌──────────────────────────────────────────────────┐
│     BIỂU MẦU 7: THÔNG TIN HỘI VIÊN               │
├──────────────────────────────────────────────────┤
│                                                  │
│  Họ tên:                [____________________]   │
│                                                  │
│  CCCD:          [____________]  DOB: [__/__/____]│
│                                                  │
│  Email:                 [____________________]   │
│                                                  │
│  Số điện thoại:         [____________]           │
│                                                  │
│  Tiền chi tiêu:         [____________] đ         │
│                                                  │
│  Tiền nợ:               [____________] đ         │
│                                                  │
│  Gói tập:              [Chọn gói ▼]              │
│                        ☐ Gói 1 tháng             │
│                        ☐ Gói 3 tháng             │
│                        ☐ Gói 6 tháng             │
│                                                  │
│  [Tạo mới] [Cập nhật] [Hủy] [In]                 │
│                                                  │
└──────────────────────────────────────────────────┘


## BM8 – TRA CỨU HỘI VIÊN

B1: Nhận thông tin tra cứu (Họ tên / CCCD / Email / SĐT)
B2: Kết nối CSDL
B3: Tìm hội viên tương ứng trong bảng Customers
- Nếu không tìm thấy → thông báo → đến B7
B4: Truy vấn:
- Gói đang sử dụng
- PT hướng dẫn (nếu có)
B5: Hiển thị thông tin tra cứu (BM8)
B6: Lưu lịch sử tra cứu (nếu có)
B7: Đóng kết nối CSDL
B8: Kết thúc

┌──────────────────────────────────────────────────┐
│     BIỂU MẦU 8: TRA CỨU HỘI VIÊN                 │
├──────────────────────────────────────────────────┤
│                                                  │
│  Tìm kiếm theo:                                  │
│  ☐ Họ tên:        [____________________]        │
│  ☐ CCCD:          [____________]                │
│  ☐ Email:         [____________________]        │
│  ☐ SĐT:           [____________]                │
│                                                  │
│  [Tìm kiếm] [Đặt lại]                            │
│                                                  │
├──────────────────────────────────────────────────┤
│ Kết quả: 2 hội viên                              │
├──────────────────────────────────────────────────┤
│                                                  │
│  ID  │ Họ tên        │ SĐT        │ Nợ           │
│  ─────────────────────────────────────────────   │
│ MEM1 │ Nguyễn Văn A │ 0909111111 │ 0 đ           │
│ MEM2 │ Trần Thị B   │ 0912222222 │ 500k          │
│                                                  │
│  [Xem chi tiết] [Sửa] [Xóa]                      │
│                                                  │
└──────────────────────────────────────────────────┘


---

## BM9 – CHECK-IN

B1: Nhận thông tin check-in (Họ tên, SĐT, Ngày, Buổi tập, PT, Gói)\
B2: Kết nối CSDL
B3: Xác thực hội viên tồn tại
- Nếu không tồn tại → thông báo → B8
B4: Kiểm tra gói tập còn hiệu lực
- Nếu hết hạn → thông báo → B8
B5: Kiểm tra buổi tập hợp lệ (BM13)
B6: Ghi nhận check-in vào bảng CheckIn Logs
B7: Cập nhật số buổi đã sử dụng
B8: Đóng kết nối CSDL
B9: Kết thúc



┌──────────────────────────────────────────────────┐
│          BIỂU MẦU 9: CHECK-IN                    │
├──────────────────────────────────────────────────┤
│                                                  │
│  Họ tên / SĐT:      [____________________]       │
│                                                  │
│  Ngày:              [__/__/____]                 │
│                                                  │
│  Buổi tập:         [Chọn buổi ▼]                │
│                    ☐ Sáng (6h-9h)               │
│                    ☐ Trưa (10h-12h)             │
│                    ☐ Chiều (14h-17h)            │
│                    ☐ Tối (18h-21h)              │
│                                                  │
│  PT (nếu có):      [Chọn PT ▼]                   │
│  Gói:              [Chọn gói ▼]                  │
│                                                  │
│  [Check-in] [Hủy]                                │
│                                                  │
└──────────────────────────────────────────────────┘


---

## BM10a – GÓI DỊCH VỤ TẬP


B1: Nhận thông tin & xác định hành động (CREATE / UPDATE / DELETE)
B2: Kết nối CSDL
B3: Validation (tên không rỗng, ngày > 0, buổi > 0, giá >= 0)
  - Nếu lỗi → thông báo → B6
B4: NẾU CREATE:
  - Tạo mới bản ghi gói trong `SERVICE_PACKAGES` 
B5: NẾU UPDATE:
  - Cập nhật thông tin gói (tên, ngày, buổi, giá)
B6: NẾU DELETE:
  - Kiểm tra có hợp đồng đang dùng không 
  - Nếu có → lỗi "Không thể xóa, có học viên đang sử dụng" → B7
B7: Hiển thị kết quả (thành công hay lỗi)
B8: Đóng kết nối CSDL
B9: Kết thúc


┌──────────────────────────────────────────────────┐
│    BIỂU MẦU 10a: GÓI DỊCH VỤ TẬP                 │
├──────────────────────────────────────────────────┤
│                                                  │
│  Tên gói:           [____________________]       │
│                                                  │
│  Thời hạn (ngày):   [____________]               │
│  Số buổi:           [____________]               │
│  Giá:               [____________] đ             │
│                                                  │
│  Có PT hướng dẫn:   ☐ Có   ☐ Không              │
│                                                  │
│  Mô tả:             [__________________________] │
│                     [__________________________] │
│                                                  │
│  [Tạo mới] [Cập nhật] [Xóa] [Hủy]                │
│                                                  │
└──────────────────────────────────────────────────┘

Danh sách gói:
┌────────────────────────────────────────────┐
│ ID │ Tên gói      │ Thời hạn │ Buổi │ Giá   │
├────┼──────────────┼──────────┼──────┼───────┤
│ P01│ Gói 1 tháng  │ 30 ngày  │ 8    │ 500k  │
│ P02│ Gói 3 tháng  │ 90 ngày  │ 24   │ 1.2M  │
│ P03│ Gói 6 tháng  │ 180 ngày │ 48   │ 2.0M  │
└────┴──────────────┴──────────┴──────┴───────┘

---

## BM10b – GÓI DỊCH VỤ KHÁC


B1: Nhận thông tin dịch vụ & xác định hành động (CREATE / UPDATE)
B2: Kết nối CSDL
B3: Validation (tên không rỗng, cost >= 0, giá bán >= 0)
  - Nếu giá bán < cost → cảnh báo "Bán lỗ"
  - Nếu lỗi → thông báo → B5
B4: NẾU CREATE:
  - Tạo mới dịch vụ trong `ADDITIONAL_SERVICES`
  - NẾU UPDATE:
  - Cập nhật giá cost & giá bán
B5: Hiển thị kết quả
B6: Đóng kết nối CSDL
B7: Kết thúc


┌──────────────────────────────────────────────────┐
│    BIỂU MẦU 10b: GÓI DỊCH VỤ KHÁC                │
├──────────────────────────────────────────────────┤
│                                                  │
│  Tên dịch vụ:       [____________________]       │
│  Giá cost:          [____________] đ             │
│  Giá bán:           [____________] đ             │
│                                                  │
│  Mô tả:             [__________________________] │
│                     [__________________________] │
│                                                  │
│  [Tạo mới] [Cập nhật] [Hủy]                      │
│                                                  │
└──────────────────────────────────────────────────┘

Danh sách dịch vụ:
┌─────────────────────────────────────────┐
│ ID │ Tên dịch vụ    │ Cost   │ Giá bán  │
├────┼────────────────┼────────┼──────────┤
│ S1 │ Protein 1kg    │ 150k   │ 250k     │
│ S2 │ Nước uống      │ 20k    │ 50k      │
│ S3 │ Khăn tập       │ 30k    │ 80k      │
│ S4 │ Tủ locker     │ 100k   │ 150k     │
└────┴────────────────┴────────┴──────────┘
---

## BM11 – ĐĂNG KÝ GÓI TẬP

B1: Nhận thông tin đăng ký gói
B2: Kết nối CSDL
B3: Kiểm tra tiền nợ hiện tại của khách hàng
- Nếu tiền nợ > tien_no_toi_da → từ chối đăng ký (QĐ 6)
B4: Tạo hợp đồng mới trong bảng Contracts
B5: Gán trạng thái:
- Gói tập: chưa bắt đầu
- Thanh toán: chưa thanh toán
B6: Cập nhật PT (nếu có)
B7: Gửi email thông báo cho khách hàng
B8: Lưu thông tin gói
B9: Hiển thị kết quả (Contract_id, Invoice_id, thông tin hợp đồng)
B10: Đóng kết nối CSDL
B11: Kết thúc

┌──────────────────────────────────────────────────┐
│      BIỂU MẦU 11: ĐĂNG KÝ GÓI TẬP                │
├──────────────────────────────────────────────────┤
│                                                  │
│  Chọn hội viên:     [Chọn HV ▼]                  │
│  Gói tập:           [Chọn gói ▼]                 │
│  PT (nếu có):       [Chọn PT ▼]                  │
│                                                  │
│  Ngày bắt đầu:      [__/__/____]                 │
│  Ngày kết thúc:     [__/__/____]                 │
│  Số buổi:           [____________]               │
│  Giá tiền:          [____________] đ             │
│                                                  │
│  PP thanh toán:    ☐ Chuyển khoản               │
│                    ☐ Tiền mặt                   │
│                    ☐ Online (VNPay)             │
│                                                  │
│  [Tạo hợp đồng] [Hủy]                            │
│                                                  │
└──────────────────────────────────────────────────┘


---

## BM12 – HỒ SƠ PT

B1: Nhận thông tin PT & xác định hành động (CREATE / UPDATE)
B2: Kết nối CSDL
B3: Validation & kiểm tra trùng lặp
  - CCCD: 12 chữ số, không trùng
  - Email: hợp lệ, không trùng (QĐ 4)
  - SĐT: 10 chữ số, không trùng (QĐ 4)
  - DOB: tuổi >= 18
  - Nếu lỗi → thông báo → B8
B4: NẾU CREATE:
  - Tạo tài khoản người dùng trong `USERS` (role = "PT", status = "Active")
  - Tạo hồ sơ PT trong `PERSONAL_TRAINERS` (rating = 0, status = "Available")
  - NẾU UPDATE:
  - Cập nhật thông tin PT
B5: Truy vấn danh sách học viên hiện tại
  - SELECT từ `CONTRACTS`
B6: Hiển thị thông tin PT + danh sách học viên (PT_id, tên, email, SĐT, chuyên môn, số học viên)
B7: Đóng kết nối CSDL
B8: Kết thúc
┌──────────────────────────────────────────────────┐
│         BIỂU MẦU 12: HỒ SƠ PT                    │
├──────────────────────────────────────────────────┤
│                                                  │
│  Tên PT:            [____________________]       │
│  CCCD:              [____________]               │
│  Ngày sinh:         [__/__/____]                 │
│  Email:             [____________________]       │ 
│  SĐT:               [____________]               │
│  Chuyên môn:        [____________________]       │
│                                                  │
│  [Tạo mới] [Cập nhật] [Hủy]                      │
│                                                  │
└──────────────────────────────────────────────────┘

Danh sách PT & Học viên:
┌────────────────────────────────────┐
│ ID │ Tên PT      │ Chuyên môn │ HV │
├────┼─────────────┼────────────┼────┤
│ PT1│ Nguyễn C    │ Cardio     │ 8  │
│ PT2│ Trần D      │ Strength   │ 12 │
│ PT3│ Lê E        │ Yoga       │ 5  │
└────┴─────────────┴────────────┴────┘


---

## BM13 – ĐĂNG KÝ BUỔI TẬP

B1: Nhận thông tin đặt lịch (hội viên, PT, gói, ngày, ca tập, số tuần)
B2: Kết nối CSDL
B3: Xác thực hội viên & hợp đồng
  - SELECT từ `CONTRACTS` WHERE member_id = ? AND package_id = ? AND status = "Active"
  - Nếu không có → lỗi → B7
B4: Kiểm tra gói tập
  - Còn hiệu lực? (end_date >= scheduled_date)
  - Còn buổi? 
  - Nếu không → lỗi → B7
B5: Kiểm tra PT (nếu có) rảnh không
  - Kiểm tra PT có lịch khác trong ca & ngày này không (từ `BOOKINGS`)
  - Nếu không rảnh → thông báo → B7
B6: Tạo booking mới trong `BOOKINGS` (gán booking_id tự động)
  - status = "Pending"
B7: NẾU recurring > 1:
  - Tạo các buổi tiếp theo (hàng tuần, trong hạn hợp đồng)
  - INSERT multiple bookings
B8: Gửi email thông báo cho khách & PT (nếu có)
B9: Hiển thị kết quả (Booking_id, ngày, ca tập, buổi số mấy)
B10 Đóng kết nối CSDL
B11: Kết thúc

┌──────────────────────────────────────────────────┐
│     BIỂU MẦU 13: ĐĂNG KÝ BUỔI TẬP                │
├──────────────────────────────────────────────────┤
│                                                  │
│  Chọn hội viên:     [Chọn HV ▼]                  │
│  Gói tập:           [Chọn gói ▼]                 │
│  PT (nếu có):       [Chọn PT ▼]                  │
│                                                  │
│  Ngày tập:          [__/__/____]                 │
│  Ca tập:           ☐ Sáng (6h-9h)               │
│                    ☐ Trưa (10h-12h)             │
│                    ☐ Chiều (14h-17h)            │
│                    ☐ Tối (18h-21h)              │
│                                                  │
│  Lặp lại hàng tuần:                              │
│  ☐ Không  ☐ Có, trong vòng [__] tuần            │
│                                                  │
│  [Đăng ký] [Hủy]                                 │
│                                                  │
└──────────────────────────────────────────────────┘


---

## BM15a – HÓA ĐƠN THANH TOÁN GÓI TẬP

B1: Nhận thông tin hóa đơn 
B2: Kết nối CSDL
B3: Lấy thông tin hợp đồng & thành viên
  - SELECT từ `CONTRACTS` WHERE contract_id = ?
  - SELECT từ `MEMBERS` WHERE member_id = contract.member_id
  - Nếu không có → lỗi → B10
B4: Kiểm tra chưa thanh toán
  - Nếu payment_status = "Paid" → lỗi "Hóa đơn đã thanh toán" → B10
B5: TÍNH TOÁN chi phí:
  - subtotal = contract.price
  - Nếu có promotion_code:
    - Kiểm tra mã khuyến mãi hợp lệ
    - discount = subtotal * promotion.discount_rate
    - subtotal -= discount
  - total = subtotal + tax
B6: Tạo hóa đơn mới trong `INVOICES` (gán invoice_id tự động)
  - status = "Unpaid"
B7: Ghi nhận phương thức thanh toán:
  - NẾU Bank Transfer → lưu tài khoản ngân hàng
  - NẾU Cash → lưu "Thanh toán tại quầy"
  - NẾU Online → tạo link thanh toán (VNPay, Stripe)
B8: Tạo chi tiết hóa đơn trong `INVOICE_DETAILS`:
  - Thêm gói tập (package_id, quantity, unit_price, subtotal, tax, total)
  - Thêm dịch vụ phụ (nếu có)
B9:  gửi email cho khách
B10: Hiển thị thông tin hóa đơn:
  - Invoice_id, họ tên khách, gói, tiền tập, giảm giá, thuế, tổng
  - Hạn thanh toán, phương thức thanh toán
B11: Đóng kết nối CSDL
B12: Kết thúc
┌──────────────────────────────────────────────────┐
│    BIỂU MẦU 15a: HÓA ĐƠN THANH TOÁN              │
├──────────────────────────────────────────────────┤
│                                                  │
│  Chọn hợp đồng:     [Chọn CT ▼]                  │
│  PP thanh toán:    ☐ Chuyển khoản               │
│                    ☐ Tiền mặt                   │
│                    ☐ Online (VNPay)             │
│                                                  │
│  Mã khuyến mãi:     [____________________]       │
│  (nếu có)                                        │
│                                                  │
│  [Tạo hóa đơn] [Hủy]                             │
│                                                  │
└──────────────────────────────────────────────────┘

Hóa đơn:
┌──────────────────────────────────────────────────┐
│      HÓA ĐƠN THANH TOÁN GÓI TẬP                  │
│      Invoice ID: INV001                          │
├──────────────────────────────────────────────────┤
│                                                  │
│ Khách hàng: Nguyễn Văn A                         │
│ Email: a@gmail.com    SĐT: 0909111111            │
│                                                  │
│ Dịch vụ:                                         │
│ ├─ Gói 3 tháng           1,200,000 đ             │
│ └─ Protein 1kg               200,000 đ           │
│                                                  │
│ Cộng:                       1,400,000 đ          │
│ Giảm giá (10%):              -140,000 đ          │
│ Subtotal:                    1,260,000 đ         │
│ Thuế VAT (10%):               126,000 đ          │
│ ───────────────────────────────────────────────  │
│ TỔNG:                       1,386,000 đ          │
│                                                  │
│ Hạn thanh toán: 09/01/2025                       │
│ PP thanh toán: Chuyển khoản ngân hàng            │
│ Số tài khoản: 123456789                          │
│ Ngân hàng: Vietcombank                           │
│                                                  │
│ [In] [Email] [Thanh toán]                        │
│                                                  │
└──────────────────────────────────────────────────┘