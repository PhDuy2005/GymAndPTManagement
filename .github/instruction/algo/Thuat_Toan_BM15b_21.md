<!--
 * Generated by: GitHub Copilot (Claude Haiku 4.5)
 * Created by: Khang(KStuv)
 * Created at: 2026-01-04 10:00:00
 * Purpose: Detailed algorithms and business logic for additional service invoice (BM15b-21)
-->

## BM15b – HÓA ĐƠN THANH TOÁN DỊCH VỤ KHÁC

B1: Admin chọn hóa đơn muốn in (invoice_id)
B2: Kết nối CSDL
B3: Lấy thông tin hóa đơn từ table Invoice
  - SELECT từ `INVOICES` WHERE invoice_id = ?
  - Nếu không có → lỗi "Hóa đơn không tồn tại" → B12
B4: Lấy thông tin member từ table User
  - SELECT từ `USERS` WHERE user_id = (
      SELECT user_id FROM members WHERE member_id = invoices.member_id
    )
  - Lấy: fullname, phone_number
B5: Lấy danh sách chi tiết hóa đơn từ table Invoice_Detail
  - SELECT từ `INVOICE_DETAILS` WHERE invoice_id = ?
  - Lấy: additional_service_id, unit_price, quantity, total_amount
B6: Với mỗi chi tiết hóa đơn (nếu là dịch vụ phụ):
  - SELECT từ `ADDITIONAL_SERVICES` WHERE additional_service_id = ?
  - Lấy: name (addi_service_name)
B7: Tính toán thông tin hóa đơn:
  - subtotal = tổng (unit_price × quantity) của tất cả dịch vụ
  - discount = invoice.discount_amount (nếu có)
  - total = invoice.total_amount
  - payment_method = invoice.payment_method
B8: Kiểm tra trạng thái thanh toán
  - payment_status = invoice.payment_status
B9: Sắp xếp thông tin chi tiết dịch vụ:
  - Hiển thị từng dòng: STT, Tên dịch vụ, Đơn giá, Số lượng, Thành tiền
B10: Định dạng hóa đơn in (BM15b):
  - Header: Tên gym, ngày lập hóa đơn
  - Thông tin khách: Họ tên, Số điện thoại
  - Chi tiết dịch vụ: Bảng danh sách
  - Tóm tắt: Cộng, Giảm giá, Tổng
  - Footer: Phương thức thanh toán, Trạng thái thanh toán
B11: Lưu lịch sử in hóa đơn (nếu cần)
B12: Đóng kết nối CSDL
B13: Kết thúc

Hóa đơn In:
┌──────────────────────────────────────────────────┐
│        HÓA ĐƠN THANH TOÁN DỊCH VỤ                │
│              GYM ABC FITNESS                      │
├──────────────────────────────────────────────────┤
│ THÔNG TIN KHÁCH HÀNG:                            │
│                                                  │
│ Tên khách hàng: Nguyễn Văn A                     │
│ Số điện thoại:   0909111111                      │
│                                                  │
├──────────────────────────────────────────────────┤
│ DANH SÁCH DỊCH VỤ:                               │
│                                                  │
│ STT │ Tên dịch vụ    │ Đơn giá  │ Số lượng │ TT │
│ ───┼────────────────┼──────────┼──────────┼────│
│  1 │ Protein 1kg    │ 250,000  │    2     │500k│
│  2 │ Nước uống      │  50,000  │    5     │250k│
│  3 │ Khăn tập       │  80,000  │    1     │ 80k│
│                                                  │
├──────────────────────────────────────────────────┤
│ TỔNG HÓA ĐƠN:         830,000 đ                  │
│                                                  │
├──────────────────────────────────────────────────┤
│ PHƯƠNG THỨC THANH TOÁN:                          │
│                                                  │
│ Phương thức: Tiền mặt                            │
│ Trạng thái:  Chưa thanh toán                     │
│                                                  │
└──────────────────────────────────────────────────┘

---

## BM17 – QUẢN LÝ KHUNG GIỜ

B1: Nhận thông tin khung giờ (slot_name, start_time, end_time)
B2: Kết nối CSDL
B3: Xác định hành động (CREATE / UPDATE / DELETE)
B4: Validation:
  - slot_name không rỗng
  - start_time < end_time
  - Kiểm tra trùng lặp khung giờ (nếu CREATE)
  - Nếu lỗi → thông báo → B8
B5: NẾU CREATE:
  - Tạo mới khung giờ trong bảng `slots`
  - Gán slot_id tự động
B6: NẾU UPDATE:
  - Cập nhật slot_name, start_time, end_time của khung giờ
B7: NẾU DELETE:
  - Kiểm tra có PT nào đang sử dụng khung giờ này không
  - SELECT từ `available_slots` WHERE slot_id = ?
  - Nếu có → lỗi "Không thể xóa, khung giờ đang được sử dụng" → B8
  - Nếu không → xóa khung giờ
B8: Hiển thị kết quả (thành công hay lỗi)
B9: Hiển thị danh sách khung giờ hiện tại
B10: Đóng kết nối CSDL
B11: Kết thúc

┌──────────────────────────────────────────────────┐
│     BIỂU MẦU 17: QUẢN LÝ KHUNG GIỜ               │
├──────────────────────────────────────────────────┤
│                                                  │
│  Tên khung giờ:     [____________________]       │
│                                                  │
│  Giờ bắt đầu:       [__:__]                      │
│  Giờ kết thúc:      [__:__]                      │
│                                                  │
│  [Tạo mới] [Cập nhật] [Xóa] [Hủy]                │
│                                                  │
└──────────────────────────────────────────────────┘

Danh sách khung giờ:
┌──────────────────────────────────────────┐
│ ID │ Tên khung giờ │ Giờ bắt đầu │ Giờ kết thúc │
├────┼───────────────┼────────────┼──────────────┤
│ S1 │ Sáng          │ 06:00      │ 09:00        │
│ S2 │ Trưa          │ 10:00      │ 12:00        │
│ S3 │ Chiều         │ 14:00      │ 17:00        │
│ S4 │ Tối           │ 18:00      │ 21:00        │
│                                                  │
│ [Sửa] [Xóa]                                     │
│                                                  │
└──────────────────────────────────────────────────┘

---

## BM18 – GHI NHẬN CHỈ SỐ CƠ THỂ

B1: Nhận thông tin (member_id, weight, height, muscle_mass, body_fat_percentage)
B2: Kết nối CSDL
B3: Xác thực member tồn tại
  - SELECT từ `members` WHERE member_id = ?
  - Nếu không tồn tại → lỗi "Hội viên không tồn tại" → B9
B4: Validation dữ liệu:
  - weight > 0 (kg)
  - height > 0 (cm)
  - muscle_mass >= 0 (%)
  - body_fat_percentage >= 0 (%)
  - Nếu lỗi → thông báo → B9
B5: Tính toán BMI:
  - Chuyển height từ cm sang m: height_m = height / 100
  - BMI = weight / (height_m * height_m)
  - Làm tròn 2 chữ số thập phân
B6: Tạo bản ghi mới trong bảng `body_metrics`:
  - member_id, measured_date (ngày hiện tại), weight, height, muscle_mass, body_fat_percentage, bmi
  - metric_id tự động tăng
B7: Lưu bản ghi vào CSDL
B8: Hiển thị thông tin vừa ghi nhận (thành công)
B9: Đóng kết nối CSDL
B10: Kết thúc

┌──────────────────────────────────────────────────┐
│   BIỂU MẦU 18: GHI NHẬN CHỈ SỐ CƠ THỂ            │
├──────────────────────────────────────────────────┤
│                                                  │
│  Chọn hội viên:      [Chọn HV ▼]                 │
│                                                  │
│  Cân nặng (kg):      [____________]              │
│  Chiều cao (cm):     [____________]              │
│  Khối lượng cơ (%):  [____________]              │
│  Tỉ lệ mỡ (%):       [____________]              │
│                                                  │
│  BMI (tự tính):      [____________]              │
│                                                  │
│  [Lưu] [Hủy]                                      │
│                                                  │
└──────────────────────────────────────────────────┘

Kết quả ghi nhận:
┌──────────────────────────────────────────────────┐
│       THÔNG TIN CHỈ SỐ CƠ THỂ ĐÃ GHI NHẬN        │
├──────────────────────────────────────────────────┤
│                                                  │
│ Hội viên:         Nguyễn Văn A                   │
│ Ngày ghi nhận:    09/01/2026                     │
│                                                  │
│ Cân nặng:         75 kg                          │
│ Chiều cao:        175 cm                         │
│ BMI:              24.5                           │
│ Khối lượng cơ:    35 %                           │
│ Tỉ lệ mỡ:         18 %                           │
│                                                  │
│ [Quay lại] [In]                                  │
│                                                  │
└──────────────────────────────────────────────────┘

---

## BM19a – THỰC PHẨM

B1: Nhận thông tin thực phẩm (name, description, calories, protein_g, carbs_g, fat_g, note)
B2: Kết nối CSDL
B3: Xác định hành động (CREATE / UPDATE / DELETE)
B4: Validation:
  - name không rỗng
  - calories, protein_g, carbs_g, fat_g >= 0 (nếu có)
  - Nếu lỗi → thông báo → B9
B5: NẾU CREATE:
  - Tạo mới thực phẩm trong bảng `foods`
  - Gán food_id tự động
B6: NẾU UPDATE:
  - Cập nhật thông tin thực phẩm
B7: NẾU DELETE:
  - Kiểm tra có trong diet_details không
  - SELECT từ `diet_details` WHERE food_id = ?
  - Nếu có → lỗi "Không thể xóa, thực phẩm đang được sử dụng" → B9
  - Nếu không → xóa thực phẩm
B8: Hiển thị kết quả (thành công hay lỗi)
B9: Hiển thị danh sách thực phẩm hiện tại
B10: Đóng kết nối CSDL
B11: Kết thúc

┌──────────────────────────────────────────────────┐
│       BIỂU MẦU 19a: QUẢN LÝ THỰC PHẨM            │
├──────────────────────────────────────────────────┤
│                                                  │
│  Tên thực phẩm:      [____________________]      │
│                                                  │
│  Mô tả:              [__________________________]│
│                      [__________________________]│
│                                                  │
│  Calories (kcal):    [____________]              │
│  Protein (g):        [____________]              │
│  Carbs (g):          [____________]              │
│  Fat (g):            [____________]              │
│                                                  │
│  Ghi chú:            [__________________________]│
│                      [__________________________]│
│                                                  │
│  [Tạo mới] [Cập nhật] [Xóa] [Hủy]                │
│                                                  │
└──────────────────────────────────────────────────┘

Danh sách thực phẩm:
┌──────────────────────────────────────────────────────────┐
│ ID │ Tên thực phẩm │ Calories │ Protein │ Carbs │ Fat   │
├────┼───────────────┼──────────┼─────────┼───────┼───────┤
│ F1 │ Gà nướng      │ 165      │ 31      │ 0     │ 3.6   │
│ F2 │ Cơm trắng     │ 130      │ 2.7     │ 28    │ 0.3   │
│ F3 │ Bông cải      │ 34       │ 2.8     │ 7     │ 0.4   │
│ F4 │ Cá hồi        │ 208      │ 20      │ 0     │ 13    │
│                                                  │
│ [Sửa] [Xóa]                                     │
│                                                  │
└──────────────────────────────────────────────────────────┘

---

## BM19b – THỰC ĐƠN

B1: PT nhập thông tin thực đơn (diet_name, member_id, water_liters, note)
B2: Kết nối CSDL
B3: Xác thực member tồn tại:
  - SELECT từ `members` WHERE member_id = ?
  - Nếu không tồn tại → lỗi "Hội viên không tồn tại" → B14
B4: Tạo bản ghi mới trong bảng `daily_diets`:
  - diet_id tự động, member_id, diet_date (ngày hiện tại), water_liters, note
B5: Lưu bản ghi daily_diets
B6: PT chọn thực phẩm (food_id) từ danh sách foods
B7: Validation:
  - food_id phải tồn tại trong bảng `foods`
  - Nếu không → lỗi "Thực phẩm không tồn tại" → B14
B8: PT nhập prep_method (phương thức chuẩn bị), amount (lượng)
B9: Validation:
  - prep_method không rỗng
  - amount, water_liters > 0
  - Nếu lỗi → thông báo → B14
B10: Tạo bản ghi trong bảng `diet_details`:
  - diet_id, food_id, prep_method, amount
B11: Lưu bản ghi diet_details
B12: Cho phép PT thêm thực phẩm khác (quay lại B6) hoặc kết thúc
B13: Hiển thị kết quả thực đơn (thành công)
B14: Đóng kết nối CSDL
B15: Kết thúc

┌──────────────────────────────────────────────────┐
│     BIỂU MẦU 19b: TẠO THỰC ĐƠN                   │
├──────────────────────────────────────────────────┤
│                                                  │
│ THÔNG TIN CƠ BẢN                                 │
│                                                  │
│  Tên thực đơn:       [____________________]      │
│  Chọn hội viên:      [Chọn HV ▼]                 │
│  Nước cần uống (l):  [____________]              │
│  Ghi chú:            [__________________________]│
│                      [__________________________]│
│                                                  │
├──────────────────────────────────────────────────┤
│                                                  │
│ THỰC PHẨM ĐỀ XUẤT                                │
│                                        [+ Thêm] │
│                                                  │
│ Thực phẩm #1                                     │
│  Chọn thực phẩm:    [Chọn TP ▼]  [Xóa]          │
│  Phương thức nấu:   [__________________________]│
│  Lượng (g):         [____________]              │
│                                                  │
│ Thực phẩm #2                                     │
│  Chọn thực phẩm:    [Chọn TP ▼]  [Xóa]          │
│  Phương thức nấu:   [__________________________]│
│  Lượng (g):         [____________]              │
│                                                  │
│  [Tạo thực đơn] [Hủy]                            │
│                                                  │
└──────────────────────────────────────────────────┘

Kết quả tạo thực đơn:
┌──────────────────────────────────────────────────┐
│        THỰC ĐƠN ĐÃ TẠO THÀNH CÔNG                │
├──────────────────────────────────────────────────┤
│                                                  │
│ Hội viên:          Nguyễn Văn A                  │
│ Tên thực đơn:      Thực đơn giảm cân             │
│ Ngày:              09/01/2026                    │
│ Nước cần uống:     2.5 lít                       │
│                                                  │
├──────────────────────────────────────────────────┤
│ CHI TIẾT THỰC PHẨM:                              │
│                                                  │
│ STT │ Thực phẩm  │ Phương thức  │ Lượng │ Calo │
│ ───┼────────────┼─────────────┼───────┼──────│
│  1 │ Gà nướng   │ Nướng        │ 200g  │ 330  │
│  2 │ Cơm trắng  │ Luộc         │ 150g  │ 195  │
│  3 │ Bông cải   │ Hấp          │ 200g  │  68  │
│                                                  │
│  [Quay lại] [In]                                 │
│                                                  │
└──────────────────────────────────────────────────┘

---

## BM20 – THIẾT BỊ

B1: Nhận thông tin thiết bị (name, type, price, date_imported, date_maintenance)
B2: Kết nối CSDL
B3: Xác định hành động (CREATE / UPDATE / DELETE)
B4: Validation:
  - name không rỗng
  - price >= 0 (nếu có)
  - date_imported <= ngày hiện tại (nếu có)
  - date_maintenance >= date_imported (nếu có cả hai)
  - Nếu lỗi → thông báo → B9
B5: NẾU CREATE:
  - Tạo mới thiết bị trong bảng `workout_devices`
  - Gán device_id tự động
B6: NẾU UPDATE:
  - Cập nhật thông tin thiết bị
B7: NẾU DELETE:
  - Kiểm tra có trong workout không
  - SELECT từ `workouts` WHERE device_id = ?
  - Nếu có → lỗi "Không thể xóa, thiết bị đang được sử dụng" → B9
  - Nếu không → xóa thiết bị
B8: Hiển thị kết quả (thành công hay lỗi)
B9: Hiển thị danh sách thiết bị hiện tại
B10: Đóng kết nối CSDL
B11: Kết thúc

┌──────────────────────────────────────────────────┐
│        BIỂU MẦU 20: QUẢN LÝ THIẾT BỊ             │
├──────────────────────────────────────────────────┤
│                                                  │
│  Tên thiết bị:       [____________________]      │
│  Loại:               [____________________]      │
│  Giá (đ):            [____________]              │
│  Ngày nhập:          [__/__/____]                │
│  Ngày bảo trì:       [__/__/____]                │
│                                                  │
│  [Tạo mới] [Cập nhật] [Xóa] [Hủy]                │
│                                                  │
└──────────────────────────────────────────────────┘

Danh sách thiết bị:
┌────────────────────────────────────────────────────────┐
│ ID │ Tên thiết bị    │ Loại     │ Giá     │ Bảo trì   │
├────┼─────────────────┼──────────┼─────────┼───────────┤
│ D1 │ Treadmill       │ Cardio   │ 15M     │ 15/06/26  │
│ D2 │ Dumbbell Set    │ Weight   │ 5M      │ 20/06/26  │
│ D3 │ Barbell         │ Weight   │ 8M      │ 25/07/26  │
│ D4 │ Yoga Mat        │ Yoga     │ 500k    │ 30/08/26  │
│                                                  │
│ [Sửa] [Xóa]                                     │
│                                                  │
└────────────────────────────────────────────────────────┘

---

## BM21 – BÀI TẬP

B1: PT chọn thiết bị (device_id) từ danh sách thiết bị hoặc không chọn (nullable)
B2: Kết nối CSDL
B3: Nếu chọn device_id, xác thực thiết bị tồn tại:
  - SELECT từ `workout_devices` WHERE device_id = ?
  - Nếu không tồn tại → lỗi "Thiết bị không tồn tại" → B12
B4: PT nhập thông tin bài tập (name, description)
B5: Validation:
  - name không rỗng
  - Nếu lỗi → thông báo → B12
B6: Tạo bản ghi mới trong bảng `workouts`:
  - workout_id tự động, pt_id (người tạo), device_id (nếu chọn), name, description
B7: Lưu bản ghi workout vào CSDL
B8: PT nhập hình ảnh bài tập (image_url)
B9: Validation:
  - image_url không rỗng, đúng định dạng URL
  - Nếu lỗi → thông báo → B12
B10: Tạo bản ghi trong bảng `workout_images`:
  - image_id tự động, workout_id, image_url
B11: Cho phép PT thêm hình ảnh khác (quay lại B8) hoặc kết thúc
B12: Hiển thị kết quả bài tập (thành công)
B13: Đóng kết nối CSDL
B14: Kết thúc

┌──────────────────────────────────────────────────┐
│       BIỂU MẦU 21: TẠO BÀI TẬP                   │
├──────────────────────────────────────────────────┤
│                                                  │
│ THÔNG TIN BÀI TẬP                                │
│                                                  │
│  Tên bài tập:        [____________________]      │
│  Chọn thiết bị:      [Chọn thiết bị ▼]           │
│                                                  │
│  Mô tả:              [__________________________]│
│                      [__________________________]│
│                      [__________________________]│
│                                                  │
├──────────────────────────────────────────────────┤
│                                                  │
│ HÌNH ẢNH BÀI TẬP                  [+ Thêm ảnh] │
│                                                  │
│ Hình ảnh #1                                      │
│  URL hình ảnh:      [__________________________]│
│                     [Xóa]                       │
│                                                  │
│ Hình ảnh #2                                      │
│  URL hình ảnh:      [__________________________]│
│                     [Xóa]                       │
│                                                  │
│  [Tạo bài tập] [Hủy]                             │
│                                                  │
└──────────────────────────────────────────────────┘

Kết quả tạo bài tập:
┌──────────────────────────────────────────────────┐
│        BÀI TẬP ĐÃ TẠO THÀNH CÔNG                 │
├──────────────────────────────────────────────────┤
│                                                  │
│ Tên bài tập:       Push-up Chuẩn                 │
│ PT tạo:            Trần Văn D                    │
│ Thiết bị:          Không (Body weight)           │
│                                                  │
├──────────────────────────────────────────────────┤
│ MÔ TẢ:                                           │
│ Bài tập push-up chuẩn giúp rèn luyện cơ ngực,  │
│ cơ vai, cơ tay. Thực hiện 3 sets, mỗi set 15   │
│ lần.                                            │
│                                                  │
├──────────────────────────────────────────────────┤
│ HÌNH ẢNH BÀI TẬP:                                │
│                                                  │
│ Hình ảnh 1: [✓] Đã tải                           │
│ Hình ảnh 2: [✓] Đã tải                           │
│                                                  │
│  [Quay lại] [Sửa] [Xóa]                          │
│                                                  │
└──────────────────────────────────────────────────┘

